<div class="container-fluid ">
  <div class="pharma-smart-content p-2">
    <p-toolbar>
      <ng-template #start>
        <div class="d-flex justify-content-between">
          <div class="mr-1">
            <p-select (onChange)="onTypeVenteChange()" [(ngModel)]="typeVenteSelected"
                      [options]="typeVentes" size="large"></p-select>
          </div>
          <div class="mr-1">
            <p-select
              #userControl
              [(ngModel)]="selectedUserId"
              [options]="users"
              id="selectedUserId"
              inputId="selectedUserId"
              optionLabel="abbrName"
              optionValue="id"
              size="large"

            ></p-select>
          </div>

          <div class="mr-1">
            <p-inputgroup>
              <input (keyup.enter)="onSearch()" pInputText placeholder="Taper pour rechercher"
                     type="text" />
              <p-inputgroup-addon>
                <p-checkbox [(ngModel)]="global" [binary]="true" id="global" inputId="global"
                            pTooltip="Recherche globale"></p-checkbox>
              </p-inputgroup-addon>
            </p-inputgroup>
          </div>

          <div class="mr-1">
            <p-floatlabel variant="on">
              <p-datePicker
                [(ngModel)]="fromDate"
                [maxDate]="toDate"
                [selectOtherMonths]="true"
                [showButtonBar]="true"
                dateFormat="dd/mm/yy"
                id="toDate"
              >
              </p-datePicker>
              <label for="toDate">Du</label>
            </p-floatlabel>
          </div>
          <div class="mr-1">
            <p-floatlabel variant="on">
              <p-datePicker
                [(ngModel)]="toDate"
                [minDate]="fromDate"
                [selectOtherMonths]="true"
                [showButtonBar]="true"
                dateFormat="dd/mm/yy"
                id="toDate"
                inputId="toDate"
              ></p-datePicker>
              <label for="toDate">Au</label>
            </p-floatlabel>
          </div>
          <div class="mr-1">
            <p-floatlabel variant="on">
              <p-select [(ngModel)]="fromHour" [options]="hous" id="fromHour"
                        size="large"></p-select>
              <label for="fromHour">De</label>
            </p-floatlabel>
          </div>
          <div class="mr-1">
            <p-floatlabel variant="on">
              <p-select [(ngModel)]="toHour" [options]="hous" id="toHour" size="large"></p-select>
              <label for="hous">A</label>
            </p-floatlabel>
          </div>
        </div>
      </ng-template>
      <ng-template #end>
        <div class="sale d-flex">
          @if (isLargeScreen) {
            <div>
              <p-button class="mr-1" [raised]="true" (click)="loadPage()" severity="info"
                        icon="pi pi-search"
                        label="Rechercher"></p-button>

              <p-button [routerLink]="['/sales', false, 'new']" icon="pi pi-plus"
                        label="Nouvelle vente" severity="primary" [raised]="true">
              </p-button>
            </div>
          } @else {
            <p-button class="mr-1"
                      (click)="loadPage()"
                      icon="pi pi-search"
                      pTooltip="Rechercher"
                      [raised]="true"
                      [rounded]="true"

                      severity="info"
                      tooltipPosition="top"
            ></p-button>

            <!--   <p-splitbutton [model]="splitbuttons" icon="pi pi-upload"
              pTooltip="Exporter" styleClass="p-button-raised p-button-help"
            tooltipPosition="top"></p-splitbutton>-->
            <p-button
              [routerLink]="['/sales', false, 'new']"
              icon="pi pi-plus"
              pTooltip="Nouvelle vente"
              raised="true"
              [rounded]="true"
              severity="success"
              tooltipPosition="top"
            >
            </p-button>
          }
        </div>
      </ng-template>
    </p-toolbar>
    <div class="mt-3 -mb-3">
      @if (sales && sales.length > 0) {
        <p-table
          (onLazyLoad)="lazyLoading($event)"
          [(selection)]="selectedEl"
          [lazy]="true"
          [loading]="loading"
          [paginator]="true"
          [rowsPerPageOptions]="[5, 10, 15, 20, 30, 50]"
          [rows]="itemsPerPage"
          [showCurrentPageReport]="true"
          [totalRecords]="totalItems"
          [value]="sales"
          class="pharma-table"
          currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} ventes"
          dataKey="id"
          stripedRows="true"
          selectionMode="single"

        >
          <ng-template #header>
            <tr class="pharma-table-head">
              <th style="width: 3%"></th>
              <th style="width: 12%">Date</th>
              <th style="width: 5%">Type</th>
              <th style="width: 8%">Référence</th>
              <th style="width: 6%">Nbre d'articles</th>
              <th style="width: 6%">Montant</th>
              <th style="width: 16%">Client</th>
              <th style="width: 15%">Vendeur</th>
              <th style="width: 15%">Caissier</th>
              <th style="width: 14%"></th>
            </tr>
          </ng-template>
          <ng-template let-expanded="expanded" let-sale #body>
            <tr>
              <td>
                <p-button
                  [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                  [pRowToggler]="sale"
                  [rounded]="true"
                  [text]="true"
                  type="button"
                />
              </td>
              <td>{{ sale.updatedAt | date: 'dd/MM/yyyy HH:mm:ss' }}</td>
              @if (sale.natureVente === 'ASSURANCE') {
                <td><span class="pharma-badge pharma-badge-info">Assurance</span></td>
              } @else if (sale.natureVente === 'CARNET') {
                <td><span class="pharma-badge pharma-badge-info">Carnet</span></td>
              } @else {
                <td><span class="pharma-badge pharma-badge-info">VNO</span></td>
              }
              <td class="pharma-code">{{ sale.numberTransaction }}</td>
              <td class="text-right">{{ sale.salesLines.length | number }}</td>
              <td class="pharma-total">{{ sale.salesAmount | number }}</td>
              <td class="pharma-entity-name">{{ sale.customer?.fullName }}</td>
              <td>{{ sale.seller?.abbrName }}</td>
              <td>{{ sale.cassier?.abbrName }}</td>
              <td>
                <div class="btn-group d-flex justify-content-end">
                  <p-button
                    [routerLink]="['/sales', sale.id, 'view']"
                    class="mr-1"
                    icon="pi pi-eye"
                    [rounded]="true"
                    [text]="true"
                    severity="info"
                    size="small"
                    pTooltip="Voir"
                  >
                  </p-button>
                  @if (canEdit && (sale.natureVente === 'ASSURANCE' || sale.natureVente
                    === 'CARNET')) {

                    <p-button
                      [routerLink]="['/sales', sale.id, false, 'edit']"
                      [rounded]="true"
                      severity="success"
                      [text]="true"
                      size="small"
                      icon="pi pi-pencil"
                      pTooltip="Editer"
                    >
                    </p-button>
                    <p-button
                      (click)="onEditCustomer(sale)"
                      [rounded]="true"
                      severity="help"
                      [text]="true"
                      size="small"
                      icon="pi pi-user-edit"
                      pTooltip="Modifier les informations du client"
                    >
                    </p-button>
                    <p-button
                      (click)="editSaleUpdatedDate(sale)"
                      [rounded]="true"
                      severity="contrast"
                      [text]="true"
                      size="small"
                      icon="pi pi-calendar-plus"
                      pTooltip="Modifier la date"
                    >
                    </p-button>

                  }

                  @if (sale.customer) {
                    <p-button
                      (click)="printSale(sale)"
                      class="ml-1"
                      [rounded]="true"
                      [text]="true"
                      severity="secondary"
                      size="small"
                      icon="pi pi-print"
                      pTooltip="Imprimer"
                    ></p-button>
                    <p-button
                      (click)="print(sale)"
                      icon="pi pi-receipt"
                      [rounded]="true"
                      [text]="true"
                      severity="warn"
                      size="small"
                      pTooltip="Imprimer la facture"
                    ></p-button>
                  }

                  <p-button
                    (click)="suggerer(sale)"
                    [hidden]="true"
                    [text]="true"
                    class="ml-1"
                    icon="pi pi-send"
                    [rounded]="true"
                    severity="help"
                    size="small"
                    pTooltip="Suggérer"
                  ></p-button>
                  @if (canCancel) {
                    <p-button
                      (click)="confirmRemove(sale)"
                      class="ml-1"
                      icon="pi pi-trash"
                      [text]="true"
                      [rounded]="true"
                      severity="danger"
                      size="small"
                      pTooltip="Annuler"
                    ></p-button>
                  }
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template let-elRow #expandedrow>
            <tr>
              <td colspan="10">
                <div class="p-3  expanded-content pharma-smart">
                  @if (elRow.categorie === 'VNO') {
                    <p-card>
                      <ng-template #title>
                        <div class="card-title primary-title">
                          <i class="pi pi-cog mr-2"></i>
                          Liste des produits
                        </div>
                      </ng-template>
                      <p-table
                        [paginator]="true"
                        [rowsPerPageOptions]="[10, 15, 20, 30, 50]"
                        [rows]="10"
                        [showCurrentPageReport]="true"
                        [value]="elRow.salesLines"
                        currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} produits"
                        dataKey="id"
                        selectionMode="single"
                        styleClass="p-datatable-striped rowexpansion-table"
                      >
                        <ng-template #header>
                          <tr>
                            <th style="width: 5%">#</th>
                            <th style="width: 10%">CODE</th>
                            <th style="width: 44%">LIBELLE</th>
                            <th style="width: 8%">QTE.D</th>
                            <th style="width: 8%">QTE.S</th>
                            <th style="width: 9%">PU</th>
                            <th style="width: 10%">TOTAL</th>
                          </tr>
                        </ng-template>
                        <ng-template let-rowIndex="rowIndex" let-saleLine #body>
                          <tr
                            [ngClass]="{ 'table-danger': saleLine.quantitySold < saleLine.quantityRequested }">
                            <td style="text-align: left">{{ rowIndex + 1 }}</td>
                            <td>{{ saleLine.code }}</td>
                            <td>{{ saleLine.produitLibelle }}</td>
                            <td class="text-right">{{ saleLine.quantityRequested | number }}</td>
                            <td class="text-right">{{ saleLine.quantitySold | number }}</td>
                            <td class="text-right">{{ saleLine.regularUnitPrice | number }}</td>
                            <td
                              style="text-align: right; font-weight: bold">{{ saleLine.salesAmount | number }}
                            </td>
                          </tr>
                        </ng-template>
                      </p-table>

                    </p-card>
                  } @else {
                    <div class="row">
                      <div class="mb-3 col-md-12 col-sm-12 col-lg-12 col-xl-5 col-xxl-6">
                        <p-card>
                          <ng-template #title>
                            <div class="card-title primary-title">
                              <i class="pi pi-info-circle mr-2"></i>
                              Informations Générales
                            </div>
                          </ng-template>
                          <div class="grid">
                            <div class="col-12">
                              <div class="field">
                                <label>MONTANT TTC</label>
                                <span>{{ elRow?.salesAmount | number }}</span>
                              </div>

                              <div class="field">
                                <label>MONTANT HT</label>
                                <span>{{ elRow?.htAmount | number }}</span>
                              </div>

                              <div class="field">
                                <label>MONTANT TAXE</label>
                                <span>{{ elRow?.taxAmount | number }}</span>
                              </div>
                              <div class="field">
                                <label>MONTANT ASSURE</label>
                                <span>{{ elRow?.partAssure | number }}</span>
                              </div>
                              <div class="field">
                                <label>MONTANT ASSURANCE</label>
                                <span>{{ elRow?.partTiersPayant | number }}</span>
                              </div>
                              @if (elRow?.discountAmount > 0) {
                                <div class="field">
                                  <label>REMISE</label>
                                  <span>{{ elRow?.discountAmount | number }}</span>
                                </div>
                              }


                              <div class="field">
                                <label>RESTE A PAYER</label>
                                <span>{{ elRow?.restToPay | number }}</span>
                              </div>

                              @for (tp of elRow?.thirdPartySaleLines; track tp) {
                                <div class="field">
                                  <label>{{ tp?.tiersPayantFullName }}</label>
                                  <span>{{ tp?.taux + '%' }}</span>
                                </div>
                                <div class="field">
                                  <label>MONTANT {{ tp?.tiersPayantFullName }}</label>
                                  <span>{{ tp?.montant | number }}</span>
                                </div>

                              }
                              @for (payment of elRow?.payments; track payment) {
                                <div class="field">
                                  <label> {{ payment?.paymentMode?.libelle }}</label>
                                  <span>{{ payment?.paidAmount | number }}</span>
                                </div>

                              }


                            </div>
                          </div>

                        </p-card>
                      </div>
                      <div class="col-md-12 col-sm-12 col-lg-12 col-xl-7 col-xxl-6">
                        <p-card>
                          <ng-template #title>
                            <div class="card-title info-title">
                              <i class="pi pi-cog mr-2"></i>
                              Liste des produits
                            </div>
                          </ng-template>
                          <p-table
                            [paginator]="true"
                            [rowsPerPageOptions]="[10, 15, 20, 30, 50]"
                            [rows]="10"
                            [showCurrentPageReport]="true"
                            [value]="elRow.salesLines"
                            currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} produits"
                            dataKey="id"
                            selectionMode="single"

                          >
                            <ng-template #header>
                              <tr>
                                <th style="width: 3%">#</th>
                                <th style="width: 12%">CODE</th>
                                <th style="width: 42%">LIBELLE</th>
                                <th style="width: 9%">QTE.D</th>
                                <th style="width: 9%">QTE.S</th>
                                <th style="width: 9%">PU</th>
                                <th style="width: 10%">TOTAL</th>
                              </tr>
                            </ng-template>
                            <ng-template let-rowIndex="rowIndex" let-saleLine #body>
                              <tr
                                [ngClass]="{ 'table-danger': saleLine.quantitySold < saleLine.quantityRequested }">
                                <td style="text-align: left">{{ rowIndex + 1 }}</td>
                                <td>{{ saleLine.code }}</td>
                                <td>{{ saleLine.produitLibelle }}</td>
                                <td class="text-right">{{ saleLine.quantityRequested | number }}
                                </td>
                                <td class="text-right">{{ saleLine.quantitySold | number }}</td>
                                <td class="text-right">{{ saleLine.regularUnitPrice | number }}</td>
                                <td
                                  style="text-align: right; font-weight: bold">{{ saleLine.salesAmount | number }}
                                </td>
                              </tr>
                            </ng-template>
                          </p-table>
                        </p-card>
                      </div>


                    </div>
                  }
                </div>

              </td>
            </tr>
          </ng-template>
        </p-table>
      } @else {
        <div class="alert alert-warning" id="no-result">
          <span>Aucune donnée trouvée</span>
        </div>
      }
    </div>
  </div>


</div>
<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>

