<div class="row">
  <div class="col-12 d-flex justify-content-end dashboard-toggle mt-1 mb-1">
    <div class="custom-segment-control">
      <div class="segment-track">
        <div class="segment-slider" [class.active-right]="showGraphs"></div>
        <button
          type="button"
          class="segment-option"
          [class.active]="!showGraphs"
          (click)="showGraphs = false; onToggleChange({ checked: false })"
        >
          <i class="pi pi-table"></i>
          <span>Vue Tabulaire</span>
        </button>
        <button
          type="button"
          class="segment-option"
          [class.active]="showGraphs"
          (click)="showGraphs = true; onToggleChange({ checked: true })"
        >
          <i class="pi pi-chart-bar"></i>
          <span>Vue Graphique</span>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <!-- Card 1: Total Montant Global -->
  <div class="col-xl-3 col-md-6 mb-2">
    <div class="card h-100 kpi-card primary-accent">
      <div class="card-body">
        <div class="kpi-header">
          <div class="kpi-content">
            <p class="kpi-label">Total montant global</p>
            <h4 class="kpi-value">
              <span>{{ venteRecord?.salesAmount | number }}</span>
              <span class="value-suffix">TTC</span>
            </h4>
            <div class="kpi-badges">
              <span class="badge bg-success-subtle text-success">{{ venteRecord?.htAmount | number }} HT</span>
              <span class="badge bg-info-subtle text-info">{{ venteRecord?.taxAmount | number }} TVA</span>
            </div>
          </div>
          <div class="kpi-icon text-primary">
            <fa-icon [icon]="faShoppingBasket"></fa-icon>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <span class="footer-label">Nombre de ventes</span>
        <span class="badge bg-warning-subtle text-warning">{{ venteRecord?.saleCount | number }}</span>
      </div>
    </div>
  </div>

  <!-- Card 2: Total en Net -->
  <div class="col-xl-3 col-md-6 mb-2">
    <div class="card h-100 kpi-card danger-accent">
      <div class="card-body">
        <div class="kpi-header">
          <div class="kpi-content">
            <p class="kpi-label">Total en net</p>
            <h4 class="kpi-value">
              <span>{{ venteRecord?.netAmount | number }}</span>
            </h4>
            <div class="kpi-badges">
              <span class="badge bg-primary-subtle text-primary">{{ venteRecord?.paidAmount | number }} Comptant</span>
              <span class="badge bg-danger-subtle text-danger">{{ venteRecord?.restToPay | number }} Crédit</span>
            </div>
          </div>
          <div class="kpi-icon text-danger">
            <fa-icon [icon]="faShippingFast"></fa-icon>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <span class="footer-label">Remise</span>
        <span class="badge bg-primary-subtle text-primary">{{ venteRecord?.discountAmount | number }}</span>
      </div>
    </div>
  </div>

  <!-- Card 3: Chiffres d'affaires par type -->
  <div class="col-xl-3 col-md-6 mb-2">
    <div class="card h-100 kpi-card success-accent">
      <div class="card-body">
        <div class="kpi-header">
          <div class="kpi-content">
            <p class="kpi-label">Chiffres d'affaires par type</p>
            <h4 class="kpi-value">
              <span>{{ (vno?.salesAmount || 0) + (assurance?.salesAmount || 0) | number }}</span>
            </h4>
            <div class="kpi-badges">
              <span class="badge bg-primary-subtle text-primary">{{ vno?.salesAmount | number }} Comptant</span>
              <span class="badge bg-danger-subtle text-danger">{{ assurance?.salesAmount | number }} Crédit</span>
            </div>
          </div>
          <div class="kpi-icon text-success">
            <fa-icon [icon]="faChartLine"></fa-icon>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <span class="footer-label">Annulations</span>
        @if (canceled?.salesAmount) {
          <span class="badge bg-secondary-subtle text-secondary">{{ canceled?.salesAmount | number }} ({{ canceled?.saleCount | number }})</span>
        }
      </div>
    </div>
  </div>

  <!-- Card 4: Total Achats -->
  <div class="col-xl-3 col-md-6 mb-2">
    <div class="card h-100 kpi-card warning-accent">
      <div class="card-body">
        <div class="kpi-header">
          <div class="kpi-content">
            <p class="kpi-label">Total montant des achats</p>
            <h4 class="kpi-value">
              <span>{{ achatRecord?.receiptAmount | number }}</span>
              <span class="value-suffix">TTC</span>
            </h4>
            <div class="kpi-badges">
              <span class="badge bg-success-subtle text-success">{{ achatRecord?.netAmount | number }} HT</span>
              <span class="badge bg-info-subtle text-info">{{ achatRecord?.taxAmount | number }} TVA</span>
            </div>
          </div>
          <div class="kpi-icon text-warning">
            <fa-icon [icon]="faCommentsDollar"></fa-icon>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <span class="footer-label">Nombre d'achats</span>
        <span class="badge bg-warning-subtle text-warning">{{ achatRecord?.achatCount | number }}</span>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Card 5: Total par mode reglement -->
  <div class="col-xl-6 col-md-6 mb-2">
    <div class="card h-100 data-card">
      <div class="card-header">
        <h5 class="card-title">
          <fa-icon [icon]="faCreditCard" class="text-info"></fa-icon>
          Total par mode de règlement
        </h5>
      </div>
      <div class="card-body py-4">
        @if (!showGraphs) {
          <ul class="list-group list-group-flush">
            @for (mode of venteModePaiments; track mode.libelle) {
              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                {{ mode.libelle }}
                <span class="fw-semibold text-primary fs-6">{{ mode?.paidAmount | number }}</span>
              </li>
            }
          </ul>
        } @else {

          <div class="d-flex justify-content-center align-items-center h-100">
            <p-chart type="pie" [data]="modePaimentChartData" [options]="modePaimentChartOptions"
                     height="300"></p-chart>
          </div>
        }
      </div>
    </div>
  </div>
  <!-- Card 6: Ventes par tiers-payant -->
  <div class="col-xl-6 col-md-6 mb-2">
    <div class="card h-100 data-card">
      <div class="card-header">
        <h5 class="card-title">
          <fa-icon [icon]="faChartPie" class="text-success"></fa-icon>
          Ventes par tiers-payant
        </h5>
        <p-select (onChange)="onTopTiersPayantChange()" [(ngModel)]="TOP_MAX_TP" [options]="tops"
                  optionLabel="label"></p-select>
      </div>
      <div class="card-body py-4">
        @if (!showGraphs) {
          <ul class="list-group list-group-flush">
            @for (tp of tiersPayantAchat; track tp.tiersPayantName) {
              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                {{ tp.tiersPayantName }}
                <span class="fw-semibold text-success fs-6">{{ tp?.montantTtc | number }}</span>
              </li>
            }
          </ul>
        } @else {
          <div class="d-flex justify-content-center align-items-center h-100">
            <p-chart type="doughnut" [data]="tiersPayantChartData"
                     [options]="tiersPayantChartOptions" height="300"></p-chart>
          </div>
        }
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-6 mb-2">
    <div class="card h-100 data-card">
      <div class="card-header">
        <h5 class="card-title">
          <fa-icon [icon]="faChartArea" class="text-primary"></fa-icon>
          Meilleures ventes en quantité
        </h5>
        <p-select (onChange)="onTopQuantityChange()" [(ngModel)]="TOP_MAX_QUANTITY"
                  [options]="tops" optionLabel="label"></p-select>
      </div>
      <div class="card-body p-0">
        @if (!showGraphs) {
          <p-table class="pharma-table" [scrollable]="true" [value]="rowQuantity" scrollHeight="400px"
                   [stripedRows]="true">
            <ng-template #header>
              <tr class="pharma-table-head">
                <th>Libellé</th>
                <th class="text-end">Montant</th>
                <th class="text-end">Quantité</th>
              </tr>
            </ng-template>
            <ng-template #body let-produit>
              <tr>
                <td>{{ produit.libelle }}</td>
                <td class="text-end">{{ produit.montantHt | number }}</td>
                <td class="text-end fw-bold text-primary">{{ produit.quantitySold | number }}</td>
              </tr>
            </ng-template>
            <ng-template #footer>
              <tr>
                <td class="fw-bold">Total</td>
                <td class="text-end fw-bold">{{ totalAmountTopQuantity | number }}</td>
                <td class="text-end fw-bold">{{ totalQuantityToQuantity | number }}</td>
              </tr>
            </ng-template>
          </p-table>
        } @else {
          <div class="p-3">
            <p-chart type="bar" [data]="quantityChartData" [options]="quantityChartOptions"
                     height="400px"></p-chart>
          </div>
        }
      </div>
    </div>
  </div>

  <div class="col-lg-6 mb-2">
    <div class="card h-100 data-card">
      <div class="card-header">
        <h5 class="card-title">
          <fa-icon [icon]="faChartBar" class="text-warning"></fa-icon>
          Meilleures ventes en valeur
        </h5>
        <p-select (onChange)="onTopAmountChange()" [(ngModel)]="TOP_MAX_AMOUNT" [options]="tops"
                  optionLabel="label"></p-select>
      </div>
      <div class="card-body p-0">
        @if (!showGraphs) {
          <p-table class="pharma-table" [scrollable]="true" [value]="rowAmount" scrollHeight="400px"
                   [stripedRows]="true">
            <ng-template #header>
              <tr class="pharma-table-head">
                <th>Libellé</th>
                <th class="text-end">Quantité</th>
                <th class="text-end">Montant</th>
              </tr>
            </ng-template>
            <ng-template #body let-produit>
              <tr>
                <td>{{ produit.libelle }}</td>
                <td class="text-end">{{ produit.quantitySold | number }}</td>
                <td class="text-end fw-bold text-warning">{{ produit.montantHt | number }}</td>
              </tr>
            </ng-template>
            <ng-template #footer>
              <tr>
                <td class="fw-bold">Total</td>
                <td class="text-end fw-bold">{{ totalQuantityTopAmount | number }}</td>
                <td class="text-end fw-bold">{{ totalAmountTopAmount | number }}</td>
              </tr>
            </ng-template>
          </p-table>
        } @else {
          <div class="p-3">
            <p-chart type="bar" [data]="amountChartData" [options]="amountChartOptions"
                     height="400px"></p-chart>
          </div>
        }
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-6 mb-2">
    <div class="card h-100 data-card">
      <div class="card-header">
        <h5 class="card-title">
          <fa-icon [icon]="faChartLine" class="text-info"></fa-icon>
          Analyse Pareto 20/80 des ventes en quantité
        </h5>
      </div>
      <div class="card-body p-0">
        @if (!showGraphs) {
          <p-table class="pharma-table" [scrollable]="true" [value]="row20x80" scrollHeight="400px"
                   [stripedRows]="true">
            <ng-template #header>
              <tr class="pharma-table-head">
                <th>Libellé</th>
                <th>Cip</th>
                <th class="text-end">Quantité</th>
                <th class="text-end">%Qté</th>

              </tr>
            </ng-template>
            <ng-template #body let-produit>
              <tr>
                <td>{{ produit.libelle }}</td>
                <td><span class="pharma-code">{{ produit.codeCip }}</span>  </td>
                <td class="text-end">{{ produit.total | number }}</td>
                <td class="text-end fw-bold text-info">{{ produit.pourcentage }}</td>

              </tr>
            </ng-template>
            <ng-template #footer>
              <tr>
                <td colspan="2" class="fw-bold">Total</td>
                <td class="text-end fw-bold">{{ totalQuantity20x80 | number }}</td>
                <td class="text-end fw-bold">{{ totalQuantityAvg | number }}</td>

              </tr>
            </ng-template>
          </p-table>
        } @else {
          <div class="p-3">
            <p-chart type="bar" [data]="twentyEightyChartData" [options]="twentyEightyChartOptions"
                     height="400px"></p-chart>
          </div>
        }
      </div>
    </div>
  </div>

  <div class="col-lg-6 mb-2">
    <div class="card h-100 data-card">
      <div class="card-header">
        <h5 class="card-title">
          <fa-icon [icon]="faChartLine" class="text-info"></fa-icon>
          Analyse Pareto 20/80 du chiffre d'affaires
        </h5>
      </div>
      <div class="card-body p-0">
        @if (!showGraphs) {
          <p-table class="pharma-table" [scrollable]="true" [value]="row20x80Montant" scrollHeight="400px"
                   [stripedRows]="true">
            <ng-template #header>
              <tr class="pharma-table-head">
                <th>Libellé</th>
                <th>Cip</th>
                <th class="text-end">Montant</th>
                <th class="text-end">%Montant</th>

              </tr>
            </ng-template>
            <ng-template #body let-produit>
              <tr>
                <td>{{ produit.libelle }}</td>
                <td><span class="pharma-code">{{ produit.codeCip }}</span>   </td>
                <td class="text-end">{{ produit.total | number }}</td>
                <td class="text-end fw-bold text-info">{{ produit.pourcentage }}</td>

              </tr>
            </ng-template>
            <ng-template #footer>
              <tr>
                <td colspan="2" class="fw-bold">Total</td>
                <td class="text-end fw-bold">{{ totalAmount20x80 | number }}</td>
                <td class="text-end fw-bold">{{ totalAmountAvg | number }}</td>

              </tr>
            </ng-template>
          </p-table>
        } @else {
          <div class="p-3">
            <p-chart type="bar" [data]="twentyEightyChartData" [options]="twentyEightyChartOptions"
                     height="400px"></p-chart>
          </div>
        }
      </div>
    </div>
  </div>
</div>
