<!-- Drawer pour ventes en attente -->
<p-drawer [(visible)]="pendingSalesSidebar" [style]="{ width: '70vw' }" position="right">
  <ng-template #header>
    <div class="drawer-header-content">
      <i class="pi pi-clock text-xl"></i>
      <div class="drawer-header-text">
        <h3>Ventes en attente</h3>
        <span class="drawer-subtitle">Reprendre une vente en cours</span>
      </div>
    </div>
  </ng-template>
  <ng-template #content>
    <jhi-prevente-modal (pendingSalesSidebarChange)="closeSideBar($event)" [user]="userCaissier"> </jhi-prevente-modal>
  </ng-template>
</p-drawer>

<!-- Interface principale -->
<div class="pharma-sales-layout">
  <!-- HEADER TOOLBAR - Actions principales toujours visibles -->
  <div class="pharma-sales-header">
    <div class="header-left">
      <p-button (click)="previousState()" [rounded]="true" [text]="true" class="back-button" icon="pi pi-arrow-left" pTooltip="Retour">
      </p-button>

      <div class="page-title">
        <h1>Point de Vente</h1>
        <p class="subtitle">Gestion des ventes {{ active }}</p>
      </div>

      <!-- Vendeur Selection (Left Side) -->
      <div
        class="header-select-wrapper"
        style="display: flex !important; flex-direction: row !important; align-items: center !important; gap: 0.75rem !important"
      >
        <label
          class="header-label"
          style="
            margin: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0.375rem !important;
            white-space: nowrap !important;
          "
        >
          <i class="pi pi-user"></i>
          <span>Vendeur</span>
        </label>
        <p-select
          #userBox
          (onChange)="onSelectUser()"
          [(ngModel)]="userSeller"
          [appendTo]="appendTo"
          [dataKey]="'id'"
          [options]="this.userVendeurService.vendeurs()"
          [placeholder]="'Sélectionner un vendeur'"
          [style]="{ width: '200px' }"
          class="pharma-select-modern"
          optionLabel="abbrName"
        >
        </p-select>
      </div>
    </div>

    <div class="header-actions">
      <!-- Customer Selection (Only for Comptant) -->
      @if (active === 'comptant' && currentSaleService.currentSale()) {
        <div class="header-customer-wrapper">
          <jhi-customer-overlay-panel (onCloseEvent)="onCustomerOverlay($event)"> </jhi-customer-overlay-panel>
        </div>
      }

      <!-- Pending Sales Button -->
      <p-button
        (click)="openPindingSide()"
        [badge]="'1'"
        [disabled]="currentSaleService.currentSale() || isPresale"
        [outlined]="true"
        badgeSeverity="danger"
        class="pending-sales-btn"
        icon="pi pi-clock"
        label="En attente"
        severity="info"
        size="small"
      >
      </p-button>
    </div>
  </div>

  <!-- MAIN CONTENT AREA -->
  <div class="pharma-sales-body">
    <!-- LEFT SIDEBAR - Sale Types Navigation -->
    <div [class.collapsed]="sidebarCollapsed()" class="sales-sidebar pharma-nav-sidebar">
      <div class="sidebar-card pharma-nav-sidebar-card">
        <div class="sidebar-header pharma-nav-sidebar-header">
          @if (!sidebarCollapsed()) {
            <i class="pi pi-shopping-cart"></i>
            <span>Type de vente</span>
          }
          <p-button
            (click)="toggleSidebar()"
            [icon]="sidebarCollapsed() ? 'pi pi-angle-right' : 'pi pi-angle-left'"
            [pTooltip]="sidebarCollapsed() ? 'Afficher le menu' : 'Masquer le menu'"
            [rounded]="true"
            [text]="true"
            class="sidebar-toggle-btn"
            size="small"
            tooltipPosition="right"
          >
          </p-button>
        </div>

        <div [class.hidden]="sidebarCollapsed()" class="sale-types-nav pharma-nav-sidebar-content">
          <div
            #nav="ngbNav"
            (navChange)="onNavChange($event)"
            [(activeId)]="active"
            class="nav flex-column nav-pills"
            ngbNav
            orientation="vertical"
          >
            <ng-container ngbNavItem="comptant">
              <a class="sale-type-link pharma-nav-vertical-link" ngbNavLink>
                <i class="pi pi-wallet"></i>
                <span>Comptant</span>
                <span class="link-arrow">›</span>
              </a>
              <ng-template ngbNavContent>
                <jhi-comptant
                  #comptant
                  (inputToFocusEvent)="getControlToFocus($event)"
                  (responseEvent)="onFinalyse($event)"
                  (saveResponse)="onSave($event)"
                  [canFocusLastModeInput]="canFocusLastModeInput"
                  [isPresale]="isPresale"
                >
                </jhi-comptant>
              </ng-template>
            </ng-container>

            <ng-container ngbNavItem="assurance">
              <a class="sale-type-link pharma-nav-vertical-link" ngbNavLink>
                <i class="pi pi-shield"></i>
                <span>Assurance</span>
                <span class="link-arrow">›</span>
              </a>
              <ng-template ngbNavContent>
                <jhi-assurance #assurance [isPresale]="isPresale"></jhi-assurance>
              </ng-template>
            </ng-container>

            <ng-container ngbNavItem="carnet">
              <a class="sale-type-link pharma-nav-vertical-link" ngbNavLink>
                <i class="pi pi-book"></i>
                <span>Carnet</span>
                <span class="link-arrow">›</span>
              </a>
              <ng-template ngbNavContent>
                <jhi-carnet #carnet [isPresale]="isPresale"></jhi-carnet>
              </ng-template>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
    <!-- MAIN WORK AREA -->
    <div class="sales-workspace">
      <!-- Insurance/Carnet Data Bar -->

      @if (active === 'assurance' || active === 'carnet') {
        <div class="insurance-data-bar">
          <jhi-assurance-data #assuranceDataComponent></jhi-assurance-data>
        </div>
        @if (showInsuranceTogle()) {
          <div class="insurance-data-bar-wrapper">
            <!-- Toggle Button -->
            <p-button
              (click)="toggleInsuranceDataBar()"
              [pTooltip]="showInsuranceDataBar() ? 'Masquer les infos assurance' : 'Afficher les infos assurance'"
              [rounded]="true"
              [text]="true"
              class="insurance-toggle-btn"
              severity="info"
              size="small"
              tooltipPosition="right"
            >
              <ng-template #content>
                <i [class]="showInsuranceDataBar() ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"></i>
                <span class="toggle-label">{{ showInsuranceDataBar() ? 'Masquer' : 'Afficher' }}</span>
              </ng-template>
            </p-button>

            <!-- Insurance Data Bar (collapsible) -->
            @if (showInsuranceDataBar()) {
              <div class="insurance-data-bar">
                <jhi-assurance-data></jhi-assurance-data>
              </div>
            }
          </div>
        }
      }
      <!-- PRODUCT SEARCH SECTION -->
      <div class="product-search-section">
        <div class="search-section-header">
          <i class="pi pi-search"></i>
          <span>Recherche de produit</span>
          <!-- <p-tag severity="info" class="ml-auto" icon="pi pi-barcode">
             <span>Scanner activé</span>
           </p-tag>-->
        </div>

        <div class="search-controls">
          <!-- Product Search Autocomplete -->
          <div class="product-search-input">
            <jhi-produit-search-autocomplete-scanner
              #produitbox
              (onBarcodeScanned)="onBarcodeScanned($event)"
              (onKeyEnter)="onSaveKeyDown($event)"
              (selectedProduit)="onSelectProduct($event)"
              [(ngModel)]="produitSelected"
              [autofocus]="true"
              [enableScanner]="true"
              [includeDetails]="true"
              [pageSize]="PRODUIT_COMBO_RESULT_SIZE"
              class="pharma-autocomplete"
            >
            </jhi-produit-search-autocomplete-scanner>
          </div>

          <!-- Quantity Input -->
          <div class="quantity-input-wrapper">
            <jhi-quantite-produt-saisie
              #produitQteCmpt
              (addQuantite)="addQuantity($event)"
              [disabledButton]="disableButton"
              [isValid]="!!produitSelected"
              class="pharma-quantity-input"
            >
            </jhi-quantite-produt-saisie>
          </div>

          <!-- Product Meta Information -->
          @if (produitSelected) {
            <div class="product-meta">
              @if (showStock) {
                <div [class.low-stock]="(produitSelected?.totalQuantity || 0) < 10" class="meta-item">
                  <i class="pi pi-database"></i>
                  <span
                    >Stock: <strong>{{ produitSelected?.totalQuantity | number }}</strong></span
                  >
                </div>
              }

              @for (rayon of produitSelected?.rayons || []; track rayon.code) {
                <div class="meta-item">
                  <i class="pi pi-map-marker"></i>
                  <span>{{ rayon.libelle }}</span>
                </div>
              }

              <div class="meta-item price-display">
                <i class="pi pi-tag"></i>
                <span
                  >Prix: <strong>{{ produitSelected?.regularUnitPrice | number }} F</strong></span
                >
              </div>
            </div>
          }
        </div>
      </div>

      <!-- SALES CONTENT -->
      <div class="sale-content-area">
        <div [ngbNavOutlet]="nav"></div>
      </div>
    </div>
  </div>
</div>

<!-- Composants de notification -->
<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>
<jhi-toast-alert #alert></jhi-toast-alert>
