<p-dialog [(visible)]="jsonDialog" [focusOnShow]="false" [modal]="true" [style]="{ width: '50vw' }"
          header="Importer un fichier json">
  <div class="ui-g form-group">
    <p-fileupload
      (uploadHandler)="onUploadJson($event)"
      [customUpload]="true"
      accept=".json"
      cancelLabel="Annuler"
      chooseLabel="Importer un fichier"
      name="importjson"
      uploadLabel="Enrégistrer"
    >
    </p-fileupload>
  </div>
  <ng-template #footer>
    <p-button (click)="cancel()" [raised]="true" class="mr-2" icon="pi pi-times" label="Annuler"
              severity="danger" type="button"></p-button>
  </ng-template>
</p-dialog>

<div class="container-fluid">
  <div class="pharma-smart-content p-2">
    <div class="pharma-toolbar">
      <div class="pharma-toolbar-header">
        <i class="pi pi-users"></i>
        <span class="pharma-toolbar-title">Liste des clients</span>
      </div>

      <p-toolbar>
        <ng-template #start>
          <div class="pharma-toolbar-filters">
            <p-floatlabel class="mr-1" variant="on">
              <p-select
                (onChange)="onTypeChange()"
                [(ngModel)]="typeSelected"
                [appendTo]="'body'"
                [filter]="false"
                [options]="types"
                id="typeFilter"
                size="large"
              >
              </p-select>
              <label for="typeFilter">Filtrer par type</label>
            </p-floatlabel>

            <p-floatlabel class="mr-1" variant="on">
              <p-select
                (onChange)="onTypeChange()"
                [(ngModel)]="statutSelected"
                [appendTo]="'body'"
                [filter]="false"
                [options]="statuts"
                id="statutFilter"
                optionLabel="label"
                optionValue="value"
                size="large"
              >
              </p-select>
              <label for="statutFilter">Statut</label>
            </p-floatlabel>

            <div class="pharma-search-input">
              <p-iconfield>
                <p-inputicon class="pi pi-search" />
                <input (keyup.enter)="onSearch()" [(ngModel)]="search" pInputText
                       placeholder="Taper pour rechercher" type="text" />
              </p-iconfield>
            </div>
          </div>
        </ng-template>

        <ng-template #end>
          <div class="pharma-toolbar-actions">
            <div class="pharma-button-group">
              <p-button (click)="loadPage()" [raised]="true" icon="pi pi-search"
                        label="Rechercher" severity="info"></p-button>

              <p-splitbutton
                [model]="newCustomerbuttons"
                [raised]="true"
                icon="pi pi-user-plus"
                label="Nouveau client"
                severity="success"
              ></p-splitbutton>
            </div>
          </div>
        </ng-template>
      </p-toolbar>
    </div>

    <div class="mt-3 mb-3">
      @if (customers && customers.length > 0) {
        <p-table
          (onLazyLoad)="lazyLoading($event)"
          [lazy]="true"
          [loading]="loading"
          [paginator]="true"
          [rowsPerPageOptions]="[10, 15, 20, 30, 50]"
          [rows]="itemsPerPage"
          [showCurrentPageReport]="true"
          [totalRecords]="totalItems"
          [value]="customers"
          class="pharma-table"
          currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} client"
          dataKey="id"
          selectionMode="single"
          stripedRows="true"
        >
          <ng-template #header>
            <tr class="pharma-table-head">
              <th style="width: 3%"></th>
              <th style="width: 10%">Catégorie</th>
              <th style="width: 30%">Nom et Prénom(s)</th>
              <th style="width: 10%">Identifiant</th>
              <th style="width: 12%">Numéro assuré</th>
              <th style="width: 10%">Téléphone</th>
              <th style="width: 10%">Encours</th>

              <th style="width: 15%"></th>
            </tr>
          </ng-template>
          <ng-template #body let-customer let-expanded="expanded">
            <tr>
              <td>
                <p-button
                  [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                  [pRowToggler]="customer"
                  [rounded]="true"
                  [text]="true"
                  type="button"
                />
              </td>
              <td>
                <span class="pharma-badge pharma-badge-info">{{ customer.categorie }}</span>
              </td>
              <td>
                <div class="pharma-entity-name">{{ customer.fullName }}</div>
              </td>
              <td>
                <span class="pharma-code">{{ customer.code }}</span>
              </td>
              <td>{{ customer.num }}</td>
              <td>{{ customer.phone }}</td>
              <td class="text-right">
                <span class="pharma-total">{{ customer.encours | number }}</span>
              </td>
              <td class="text-right">
                <div class="btn-group">
                  <p-button
                    [rounded]="true"
                    [routerLink]="['/customer', customer.id, 'view']"
                    [text]="true"
                    icon="pi pi-eye"
                    pTooltip="Voir détails"
                    severity="info"
                    type="submit"
                  >
                  </p-button>

                  @if (customer.categorie === 'ASSURE') {
                    <p-button
                      (click)="editAssureCustomer(customer)"
                      [rounded]="true"
                      [text]="true"
                      data-placement="left"
                      icon="pi pi-pencil"
                      pTooltip="Editer"
                      severity="primary"
                      type="button"
                    >
                    </p-button>
                    @if (customer.typeTiersPayant === 'ASSURANCE') {
                      <p-button
                        (click)="addAyantDroit(customer)"
                        [rounded]="true"
                        [text]="true"
                        data-placement="left"
                        icon="pi pi-users"
                        pTooltip="Ajouter un ayant droit"
                        severity="contrast"
                        type="button"
                      >
                      </p-button>
                    }
                  }

                  <!--   <button *ngIf="customer.categorie==='ASSURE'" type="button"
                             class="btn btn-secondary btn-sm" data-placement="left"
                             pTooltip="Gerer les complémentaires" (click)="editAssureCustomer(customer)">
                         <fa-icon icon="hospital-user"></fa-icon>
                     </button>-->
                  @if (customer.categorie === 'STANDARD') {
                    <p-button
                      (click)="editUninsuredCustomer(customer)"
                      [rounded]="true"
                      [text]="true"
                      data-placement="left"
                      icon="pi pi-pencil"
                      pTooltip="Editer"
                      severity="primary"
                      type="button"
                    >
                    </p-button>
                  }

                  <p-button
                    (click)="confirmRemove(customer)"
                    [rounded]="true"
                    [text]="true"
                    icon="pi pi-trash"
                    pTooltip="Supprimer"
                    severity="danger"
                    type="button"
                  >
                  </p-button>
                  <p-button
                    (click)="confirmDesactivation(customer)"
                    [rounded]="true"
                    [text]="true"
                    icon="pi pi-lock"
                    pTooltip="Désativer"
                    severity="warn"
                    type="button"
                  >
                  </p-button>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template #expandedrow let-customer>
            <tr class="pharma-expanded-row">
              <td colspan="8">
                @if (customer.type === 'ASSURE') {
                  <div class="row pharma-smart">
                    <div class="col-md-5 mb-3 mt-3">
                      <p-card>
                        <ng-template #title>
                          <div class="card-title info-title">
                            <i class="pi pi-info-circle mr-2"></i>
                            INFORMATIONS COMPLEMENTAIRES DU CLIENT
                          </div>
                        </ng-template>

                        <div class="grid">
                          <div class="col-12">
                            <div class="field">
                              <label>Date de naissance</label>
                              <span>{{ customer?.datNaiss | date: 'dd/MM/yyyy' }}</span>
                            </div>
                            <div class="field">
                              <label>Date de création</label>
                              <span>{{ customer?.createdAt | date: 'dd/MM/yyyy' }}</span>
                            </div>

                            <div class="field">
                              <label>Date de modification</label>
                              <span>{{ customer?.updatedAt | date: 'dd/MM/yyyy' }}</span>
                            </div>
                            <div class="field">
                              <label>Sexe</label>
                              <span>{{ customer?.sexe }}</span>
                            </div>

                          </div>
                        </div>


                      </p-card>

                    </div>


                    <div class="row col-md-7 mb-3 mt-3">
                      @if (customer.typeTiersPayant === 'ASSURANCE') {
                        <div class="mb-3">
                          <p-card>
                            <ng-template #title>
                              <div class="card-title primary-title">
                                <i class="pi pi-users mr-2"></i>
                                AYANTS DROITS
                              </div>
                            </ng-template>
                            <table class="table table-striped">
                              <thead class="pharma-table-head">
                              <tr>
                                <th style="width: 40%">Nom et prenom(s)</th>
                                <th style="width: 20%">N° Sécu</th>
                                <th style="width: 17%">Date de naissance</th>
                                <th style="width: 8%">Sexe</th>
                                <th style="width: 15%; text-align: right">
                                  <p-button
                                    (click)="addAyantDroit(customer)"
                                    [rounded]="true"
                                    [text]="true"
                                    icon="pi pi-plus"
                                    pTooltip="Ajouter un ayant droit"
                                    severity="info"
                                  ></p-button>
                                </th>
                              </tr>
                              </thead>
                              <tbody>
                                @for (ayantDroit of customer.ayantDroits; track ayantDroit?.id) {
                                  <tr>
                                    <td>{{ ayantDroit?.fullName }}</td>
                                    <td>{{ ayantDroit?.numAyantDroit }}</td>
                                    <td>{{ ayantDroit?.datNaiss | date: 'dd/MM/yyyy' }}</td>
                                    <td>{{ ayantDroit?.sexe }}</td>
                                    <td class="text-right">
                                      <div class="btn-group">
                                        <p-button
                                          (click)="editAyantDroit(customer, ayantDroit)"
                                          [rounded]="true"
                                          [text]="true"
                                          class="p-mb-3 mr-1"
                                          icon="pi pi-pencil"
                                          pTooltip="Editer"
                                          severity="success"
                                        ></p-button>
                                        <p-button
                                          (click)="confirmRemoveAyantDroit(ayantDroit)"
                                          [rounded]="true"
                                          [text]="true"
                                          class="p-mb-3"
                                          icon="pi pi-trash"
                                          pTooltip="Supprimer"
                                          severity="danger"
                                        ></p-button>
                                      </div>
                                    </td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </p-card>

                        </div>
                      }
                      <div class="mb-3">
                        <p-card>
                          <ng-template #title>
                            <div class="card-title secondary-title">
                              <i class="pi pi-building mr-2"></i>
                              TIERS PAYANTS
                            </div>
                          </ng-template>
                          <table class="table table-striped">
                            <thead class="pharma-table-head">
                            <tr>
                              <th style="width: 28%">Tiers-payant</th>
                              <th style="width: 14%">N° Sécu</th>
                              <th style="width: 7%">Taux</th>
                              <th style="width: 8%">Catégorie</th>
                              <th style="width: 13%">Plafond encours</th>
                              <th style="width: 13%">Plafond vente</th>
                              <!--                                            <th style="width:8%;">Plafond absolu ?</th>-->
                              @if (displayTiersPayantAddBtn(customer)) {
                                <th style="width: 11%; text-align: right">
                                  <p-button
                                    (click)="onAddNewTiersPayant(customer)"
                                    [rounded]="true"
                                    [text]="true"
                                    icon="pi pi-plus"
                                    pTooltip="Ajouter un tiers-payant"
                                    severity="info"
                                  ></p-button>
                                </th>
                              }
                            </tr>
                            </thead>
                            <tbody>
                              @for (tierspayant of customer.tiersPayants; track tierspayant?.id; let
                                i = $index) {
                                <tr>
                                  <td>{{ tierspayant?.tiersPayantFullName }}</td>
                                  <td>{{ tierspayant?.num }}</td>
                                  <td>{{ tierspayant?.taux }}</td>
                                  <td>{{ tierspayant?.priorite }}</td>
                                  <td>{{ tierspayant?.plafondConso | number }}</td>
                                  <td>{{ tierspayant?.plafondJournalier | number }}</td>
                                  <!--                                            <td>{{tierspayant?.plafondAbsolu }}</td>-->
                                  @if (displayTiersPayantAction) {
                                    <td class="text-right">
                                      <div class="btn-group">
                                        <p-button
                                          (click)="onEditTiersPayant(customer, tierspayant)"
                                          [rounded]="true"
                                          [text]="true"
                                          class="p-mb-3 mr-1"
                                          icon="pi pi-pencil"
                                          pTooltip="Editer les infos du tierspayant"
                                          severity="success"
                                        ></p-button>
                                        @if (customer.typeTiersPayant === 'ASSURANCE'
                                        && customer.tiersPayants.length > 1) {
                                          <p-button
                                            (click)="onRemoveTiersPayant(tierspayant)"
                                            [rounded]="true"
                                            [text]="true"
                                            class="p-mb-3"
                                            icon="pi pi-trash"
                                            pTooltip="Supprimer"
                                            severity="danger"
                                          ></p-button>
                                        }
                                      </div>
                                    </td>
                                  }
                                </tr>
                              }
                            </tbody>
                          </table>
                        </p-card>
                      </div>


                    </div>
                  </div>
                } @else {
                  <div class="mb-3 mt-3 pharma-smart pharma-smart-content">
                    <p-card>
                      <ng-template #title>
                        <div class="card-title info-title">
                          <i class="pi pi-info-circle mr-2"></i>
                          INFORMATIONS COMPLEMENTAIRES DU CLIENT
                        </div>
                      </ng-template>

                      <div class="grid">
                        <div class="col-12">
                          <div class="field">
                            <label>Date de naissance</label>
                            <span>{{ customer?.datNaiss | date: 'dd/MM/yyyy' }}</span>
                          </div>
                          <div class="field">
                            <label>Date de création</label>
                            <span>{{ customer?.createdAt | date: 'dd/MM/yyyy' }}</span>
                          </div>

                          <div class="field">
                            <label>Date de modification</label>
                            <span>{{ customer?.updatedAt | date: 'dd/MM/yyyy' }}</span>
                          </div>
                          <div class="field">
                            <label>Sexe</label>
                            <span>{{ customer?.sexe }}</span>
                          </div>

                        </div>
                      </div>


                    </p-card>
                  </div>
                }
              </td>
            </tr>
          </ng-template>
        </p-table>
      } @else {
        <div class="alert alert-warning mt-2">
          <span>Aucune donnée trouvée</span>
        </div>
      }
    </div>
  </div>

</div>

<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>
<jhi-spinner #spinner></jhi-spinner>
