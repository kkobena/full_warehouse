<div class="container-fluid ">
  <div class="pharma-smart-content p-2">
    @let isReceiption = commande?.orderStatus === RECEIVED;
    @if (!isReceiption) {
      <div class="pharma-toolbar">
        <div class="pharma-toolbar-header">
          <i class="pi pi-shopping-cart"></i>
          <span class="pharma-toolbar-title">Saisie de commande</span>
        </div>
        <p-toolbar>
          <ng-template #start>
            <div class="pharma-toolbar-filters">

              <div class="mr-1">
                <p-inputgroup>
                  <p-inputgroup-addon>Fournisseurs</p-inputgroup-addon>
                  <p-select
                    #fournisseurBox
                    (onChange)="onProviderSelect()"
                    [(ngModel)]="selectedProvider"
                    [appendTo]="'body'"
                    [filter]="true"
                    [fluid]="true"
                    [options]="fournisseurs"
                    optionLabel="libelle"
                    optionValue="id"
                    placeholder="Séléctionner un fournisseur "
                    size="large"
                  >
                  </p-select>
                </p-inputgroup>
              </div>


                <div [style]="{ width: '100%' }" class="input-group  ">
                  <span class="input-group-text">Produits</span>

                  <p-autoComplete
                    #produitbox
                    [forceSelection]="true"
                    (completeMethod)="searchFn($event)"
                    (onSelect)="onSelect()"
                    [(ngModel)]="produitSelected"
                    [appendTo]="APPEND_TO"
                    [dataKey]="'id'"
                    [fluid]="true"
                    [dropdown]="true"
                    [emptyMessage]="PRODUIT_NOT_FOUND"
                    [minQueryLength]="PRODUIT_COMBO_MIN_LENGTH"
                    [showEmptyMessage]="true"
                    [suggestions]="produits"
                    class="form-control"
                    optionLabel="libelle"
                  >
                    <ng-template let-item #item>
                      @if (item.totalQuantity > 0) {
                        <div [style]="{ width: '100%' }">
                        <span
                          style="width: 20%; display: inline-block">{{ item.fournisseurProduit?.codeCip }}</span
                        ><span> {{ item.libelle }}</span>
                          <span class="float-right">{{ item.regularUnitPrice | number }}</span>
                        </div>
                      }
                      @if (item.totalQuantity <= 0) {
                        <div [style]="{ width: '100%' }">
                        <span class="stockless"
                              style="width: 20%; display: inline-block">{{ item.fournisseurProduit?.codeCip }}</span
                        ><span class="stockless"> {{ item.libelle }}</span>
                          <span
                            class="float-right stockless">{{ item.regularUnitPrice | number }}</span>
                        </div>
                      }
                    </ng-template>
                  </p-autoComplete>
                </div>

              <!--<ng-template #start>-->
              <div>
                <p-inputgroup>
                  <p-inputgroup-addon>Qté</p-inputgroup-addon>
                  <input
                    #quantityBox
                    (keydown.enter)="onQuantityBoxAction($event)"
                    [(ngModel)]="quantiteSaisie"
                    [style]="{ 'min-width': '120px' }"
                    class="form-control"
                    [fluid]="true"
                    pInputText
                    type="number"
                  />
                  <p-inputgroup-addon>
                    <p-button
                      (click)="onQuantity()"
                      [disabled]="!produitSelected"
                      [raised]="true"
                      icon="pi pi-plus"
                      severity="info"
                      type="button"
                    ></p-button>
                  </p-inputgroup-addon>
                </p-inputgroup>
              </div>
            </div>
          </ng-template>
          <ng-template #end>
            <div class="pharma-toolbar-actions">

              <div class="pharma-button-group">

                <p-button
                  (click)="previousState()"
                  icon="pi pi-arrow-left"
                  id="cancel-save"
                  label="Retour"
                  raised="true"
                  severity="secondary"
                />
              </div>
            </div>

          </ng-template>

        </p-toolbar>
      </div>
    }
    @if (isReceiption) {
      <div class="pharma-toolbar">
        <div class="pharma-toolbar-header">
          <i class="pi pi-truck"></i>
          <span class="pharma-toolbar-title">Réception de commande</span>
        </div>
        <p-toolbar>
          <ng-template #start>
            <div class="pharma-toolbar-filters">
              <div class="mr-1">
                <p-iconfield>
                  <p-inputicon class="pi pi-search" />
                  <input
                    (keyup.enter)="onFilterCommandeLines()"
                    [(ngModel)]="search"
                    pInputText
                    placeholder="Taper pour rechercher"
                    type="text"
                  />
                </p-iconfield>
              </div>
              <div class="mr-1">
                <p-floatlabel variant="on">
                  <p-select
                    size="large"
                    appendTo="body"
                    (onChange)="onFilterCommandeLines()"
                    [(ngModel)]="tris"
                    [fluid]="true"
                    [options]="sorts"
                    optionLabel="label"
                    optionValue="code"
                    inputId="ordre"
                  >
                  </p-select>
                  <label for="ordre">Ordre</label>
                </p-floatlabel>
              </div>

              <div>
                <p-floatlabel variant="on">
                  <p-select
                    size="large"
                    (onChange)="onFilterCommandeLines()"
                    [(ngModel)]="selectedFilter"
                    [options]="filtres!"
                    optionLabel="label"
                    [fluid]="true"
                    appendTo="body"
                    optionValue="value"
                    inputId="selectedFilter"
                  >
                  </p-select>
                  <label for="selectedFilter">Filtrer par</label>
                </p-floatlabel>
              </div>

            </div>

          </ng-template>
          <ng-template #end>
            <div class="pharma-toolbar-actions">

              <div class="pharma-button-group">


                  @if (!isReceiption) {
                    <p-button class="mr-1" (click)="onCreateBon()" severity="primary"
                              icon="pi pi-truck"
                              label="Créer le bon"
                              [raised]="true"></p-button>

                    <p-button class="mr-1"
                              label="Importer la réponse"
                              icon="pi pi-download"
                              [raised]="true"
                              severity="info"
                              (click)="fileDialog = true"
                    />
                  } @else {
                    <p-button class="mr-1"
                              (click)="onConfirmFinalize()"
                              [raised]="true"
                              icon="pi pi-check-circle"
                              label="Valider"
                              severity="primary"
                              type="button"
                    ></p-button>
                  }

                  <p-splitbutton class="mr-1" [model]="exportbuttons" icon="pi pi-file-export"
                                 label="Exporter"
                                 severity="warn"
                                 [raised]="true" />

                  @if (!isReceiption && selectedEl!.length > 0) {
                    <p-button [raised]="true" label="Supprimer" icon="pi pi-times"
                              severity="danger"
                              (click)="confirmDeleteAll()">
                    </p-button>
                  }

              </div>
            </div>

          </ng-template>
        </p-toolbar>


      </div>


    }
    <div class="row">
      @if (isReceiption) {
        <div class="col-md-3 col-sm-12 col-lg-3 col-xl-3">

            <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span style="margin-right: 5px">Grossiste</span>
                <span class="text-primary fw-bold">{{ commande?.fournisseur?.libelle }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span style="margin-right: 5px">Référence bon</span>
                <span class="text-primary fw-bold">{{ commande?.receiptReference }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span style="margin-right: 5px">Date Bon</span>
                <span
                  class="text-primary fw-bold">{{ commande?.receiptDate | date: 'dd/MM/yyyy' }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Montant HT
                <span class="text-primary fw-bold">{{ commande?.receiptAmount | number }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Taxe
                <span class="text-primary fw-bold">{{ commande?.taxAmount | number }}</span>
              </li>
            </ul>


        </div>
      }

      <div
        [ngClass]="isReceiption ? 'col-md-9 col-sm-12 col-lg-9 col-xl-9' : 'col-md-12 col-sm-12 col-lg-12 col-xl-12'">
          @if (commande) {
            <p-table
              [(selection)]="selectedEl"
              [paginator]="true"
              [rowsPerPageOptions]="[10, 20, 30, 40, 50]"
              [rows]="10"
              [value]="orderLines"
              dataKey="id"
              class="pharma-table"
              [showGridlines]="true"
            >

              <ng-template #header>
                <tr class="pharma-table-head">
                  <th style="width: 2%">#</th>
                  <th style="width: 8%">Code</th>
                  <th style="width: 20%">Description</th>
                  <th style="width: 5%" class="text-right">Stock</th>
                  <th style="width: 8%" class="text-right">P.A</th>
                  <th style="width: 6%">P.A Machine</th>
                  <th style="width: 8%" class="text-right">P.U</th>
                  <th style="width: 6%" class="text-right">P.U Machine</th>
                  <th style="width: 8%" class="text-right">Qté</th>
                  <th style="width: 6%" class="text-right">Qté Ug</th>
                  <!--   <th style="width: 5%">T.ACHAT</th>-->
                  @if (showLotColumn()) {
                    <th style="width: 7%">Lots</th>
                    <th style="width: 7%">Date péremption</th>
                  }


                  <th style="width: 6%"></th>
                  @if (!isReceiption) {
                    <th class="text-center" style="width: 2%;">
                      <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                    </th>
                  }
                </tr>
              </ng-template>
              <ng-template let-orderLine let-rowIndex="rowIndex" #body>
                <tr [ngClass]="orderLineTableColor(orderLine)">
                  <td><span class="pharma-row-number" >{{ rowIndex + 1 }}</span>   </td>
                  @if (orderLine.provisionalCode === false || !isReceiption) {
                    <td> <span class="pharma-code">{{ orderLine.produitCip }}</span> </td>
                  } @else {
                    <td class="pharma-badge-info" pEditableColumn>
                      <p-cellEditor>
                        <ng-template #input>
                          <input
                            (focus)="$event.target.select()"
                            (keydown.enter)="onUpdateCip(orderLine, $event)"
                            [value]="orderLine.produitCip"
                            pInputText
                            required
                            style="width: 100%"
                            type="text"
                          />
                        </ng-template>
                        <ng-template #output>
                          {{ orderLine.produitCip }}
                        </ng-template>
                      </p-cellEditor>
                    </td>
                  }

                  <td><span class="pharma-entity-name">{{ orderLine.produitLibelle }}</span>  </td>
                  <td style="text-align: right">{{ orderLine.initStock | number }}</td>
                  @if (!isReceiption) {
                    <td pEditableColumn class="amount-td-column">
                      <p-cellEditor>
                        <ng-template #input>
                          <input
                            (focus)="$event.target.select()"
                            (keydown.enter)="onUpdateOrderCostAmount(orderLine, $event)"
                            [value]="orderLine.orderCostAmount"
                            pInputText
                            class="pharma-input-price"
                            required
                            type="number"
                          />
                        </ng-template>
                        <ng-template #output>
                          <span class="pharma-price"> {{ orderLine.orderCostAmount | number }}</span>
                        </ng-template>
                      </p-cellEditor>
                    </td>
                  } @else {
                    <td class="amount-td-column pharma-price"> {{ orderLine.orderCostAmount | number }}</td>

                  }

                  <td style="text-align: right">{{ orderLine.costAmount | number }}</td>
                  @if (!isReceiption) {
                    <td pEditableColumn class="amount-td-column">
                      <p-cellEditor>
                        <ng-template #input>
                          <input
                            (focus)="$event.target.select()"
                            (keydown.enter)="onUpdateOrderUnitPrice(orderLine, $event)"
                            [value]="orderLine.orderUnitPrice"
                            pInputText
                            class="pharma-input-price"
                            required
                            type="number"
                          />
                        </ng-template>
                        <ng-template #output>
                          <span class="pharma-price">{{ orderLine.orderUnitPrice | number }}</span>
                        </ng-template>
                      </p-cellEditor>
                    </td>
                  } @else {
                    <td class="amount-td-column pharma-price"> {{ orderLine.orderUnitPrice | number }}</td>

                  }

                  <td style="text-align: right">{{ orderLine.regularUnitPrice | number }}</td>
                  @if (!isReceiption) {
                    <td pEditableColumn class="amount-td-column">
                      <p-cellEditor>
                        <ng-template #input>
                          <input
                            (focus)="$event.target.select()"
                            (keydown.enter)="onUpdateQuantityRequested(orderLine, $event)"
                            [value]="orderLine.quantityRequested"
                            pInputText
                            class="pharma-input-qty"
                            required
                            type="number"
                          />
                        </ng-template>
                        <ng-template #output>
                          <span class="pharma-qty-value">{{ orderLine.quantityRequested | number }}</span>
                        </ng-template>
                      </p-cellEditor>
                    </td>
                  } @else {
                    <td class="amount-td-column">
                      <span class="pharma-qty-value">  {{ orderLine.quantityRequested | number }}</span>
                    </td>
                  }


                  <td [pEditableColumn]="orderLine.freeQty" pEditableColumnField="freeQty"
                      class="amount-td-column">
                    <p-cellEditor>
                      <ng-template #input>
                        <input
                          (focus)="$event.target.select()"
                          (keydown.enter)="onUpdateFreeQtyRequested(orderLine, $event)"
                          [value]="orderLine.freeQty"
                          class="pharma-input-qty"
                          pInputText
                          required
                          type="number"
                        />
                      </ng-template>
                      <ng-template #output>
                        <span class="pharma-qty-value"> {{ orderLine.freeQty | number }}</span>
                      </ng-template>
                    </p-cellEditor>
                  </td>

                  @if (showLotColumn()) {
                    <td>
                      @for (lot of orderLine.lots; track lot.numLot) {
                        <span> {{ lot.numLot }}</span>
                      }
                    </td>

                    <td>
                      @for (lot of orderLine.lots; track lot.numLot) {
                        <span>{{ lot.expiryDate | date: 'dd/MM/yyyy' }}</span>
                      }
                    </td>
                  }
                  <td style="text-align: right" class="d-flex justify-content-end">
                    <p-buttonGroup>
                      <p-button
                        (click)="editLigneInfos(orderLine)"
                        icon="pi pi-pencil"
                        severity="success"
                        [text]="true"
                        tooltipPosition="left"
                        pTooltip="Modifier le produit"
                      ></p-button>
                      @if (orderLine.lots.length > 0 || showLotBtn) {
                        <p-button
                          [text]="true"
                          (click)="onAddLot(orderLine)"
                          severity="info"
                          icon="pi pi-box"
                          pTooltip="Gérer le lot"
                          tooltipPosition="left"
                        ></p-button>
                      }

                      @if (!isReceiption) {
                        <p-button
                          (click)="confirmDeleteItem(orderLine)"
                          icon="pi pi-trash"
                          severity="danger"
                          [text]="true"
                          pTooltip="Supprimer"
                          tooltipPosition="left"
                        ></p-button>
                      } @else {
                        @if (orderLine.lots.length > 0 || showLotBtn) {
                          <p-button
                            (click)="confirmDeleteItem(orderLine)"
                            icon="pi pi-trash"
                            severity="danger"
                            [text]="true"
                            pTooltip="Supprimer le lot"
                            tooltipPosition="left"
                          ></p-button>
                        }
                      }
                    </p-buttonGroup>
                  </td>
                  @if (!isReceiption) {
                    <td class="text-center" style="width: 5px;">
                      <p-tableCheckbox [value]="orderLine"></p-tableCheckbox>
                    </td>
                  }
                </tr>
              </ng-template>
              @if (orderLines.length > 0) {
                <ng-template #footer>
                  <tr class="pharma-table-footer">
                    <td  colspan="4" style="font-weight: 700"><span class="pharma-footer-label">VALEUR ACHAT/VENTE</span>
                    </td>
                    <td class="amount-column text-right red-400"><span class="pharma-footer-total">{{ commande.grossAmount | number }}</span>
                    </td>
                    <td class="amount-column text-right red-400"
                        colspan="2"><span class="pharma-footer-total">{{ commande.orderAmount | number }}</span>
                    </td>
                    <td class="amount-column text-right" colspan="3"></td>
                    <td colspan="4"></td>
                  </tr>
                </ng-template>
              }
            </p-table>
          }

      </div>





    </div></div>


</div>

<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>
<jhi-toast-alert #alert></jhi-toast-alert>

<jhi-spinner #spinner></jhi-spinner>
