<div class="modal-header">
  <h4 class="modal-title">{{ header }}</h4>
  <button (click)="cancel()" class="btn-close" data-dismiss="modal" type="button">
    &times;
  </button>
</div>

<form (ngSubmit)="save()" [formGroup]="editForm" name="editForm" novalidate role="form">
  <div class="modal-body">
    <input formControlName="id" id="id" name="id" type="hidden" />

    <!-- Two Column Layout: Champs Obligatoires and Informations Générales -->
    <div class="card-grid-2col">
      <!-- Section 1: Champs Obligatoires -->
      <p-card>
        <ng-template #header>
          <div class="section-header section-header-required">
            <i class="pi pi-exclamation-circle"></i>
            <span>Champs Obligatoires</span>
          </div>
        </ng-template>

        <div class="form-grid-compact">
          <!-- Nom abrégé -->
          <div class="form-field form-field-full">
            <label for="field_libelle">Nom abrégé <span class="required">*</span></label>
            <input
              #name
              pInputText
              id="field_libelle"
              formControlName="name"
              class="w-full"
              autocomplete="off"
              [class.ng-invalid]="editForm.get('name')?.invalid && editForm.get('name')?.touched" />
            @if (editForm.get('name')?.invalid && editForm.get('name')?.touched) {
              @if (editForm.get('name')?.errors?.required) {
                <small class="p-error" jhiTranslate="entity.validation.required">Ce champ est obligatoire</small>
              }
            }
          </div>

          <!-- Nom long -->
          <div class="form-field form-field-full">
            <label for="field_fullName">Nom long <span class="required">*</span></label>
            <input
              pInputText
              id="field_fullName"
              formControlName="fullName"
              class="w-full"
              autocomplete="off"
              [class.ng-invalid]="editForm.get('fullName')?.invalid && editForm.get('fullName')?.touched" />
            @if (editForm.get('fullName')?.invalid && editForm.get('fullName')?.touched) {
              @if (editForm.get('fullName')?.errors?.required) {
                <small class="p-error" jhiTranslate="entity.validation.required">Ce champ est obligatoire</small>
              }
            }
          </div>
        </div>
      </p-card>

      <!-- Section 2: Informations Générales -->
      <p-card>
        <ng-template #header>
          <div class="section-header">
            <i class="pi pi-info-circle"></i>
            <span>Informations Générales</span>
          </div>
        </ng-template>

        <div class="form-grid-compact">
          <!-- Identifiant contribuable -->
          <div class="form-field form-field-full">
            <label for="ncc">Identifiant contribuable</label>
            <input
              pInputText
              pKeyFilter="alphanum"
              id="ncc"
              formControlName="ncc"
              class="w-full"
              autocomplete="off" />
          </div>

          <!-- Groupe tiers-payant -->
          <div class="form-field form-field-full">
            <label for="groupeTiersPayantId">Groupe tiers-payant</label>
            <p-select
              id="groupeTiersPayantId"
              formControlName="groupeTiersPayantId"
              [options]="groupeTiersPayants"
              optionLabel="name"
              optionValue="id"
              placeholder="Sélectionner un groupe"
              [fluid]="true">
            </p-select>
          </div>

          <!-- Code organisme -->
          <div class="form-field form-field-full">
            <label for="codeOrganisme">Code organisme</label>
            <input
              pInputText
              pKeyFilter="alphanum"
              id="codeOrganisme"
              formControlName="codeOrganisme"
              class="w-full"
              autocomplete="off" />
          </div>

          <!-- Téléphone -->
          <div class="form-field form-field-full">
            <label for="telephone">Téléphone</label>
            <input
              pInputText
              pKeyFilter="int"
              id="telephone"
              formControlName="telephone"
              type="tel"
              class="w-full"
              autocomplete="off" />
          </div>
        </div>
      </p-card>
    </div>

    <!-- Three Column Layout: Paramètres de Facturation, Plafonds et Remises, and Plafonds Clients -->
    <div class="card-grid-3col mt-2">
      <!-- Section 3: Paramètres de Facturation -->
      <p-card>
        <ng-template #header>
          <div class="section-header">
            <i class="pi pi-file-edit"></i>
            <span>Paramètres de Facturation</span>
          </div>
        </ng-template>

        <div class="form-grid-compact">
          <!-- Nombre maxi de bordereau -->
          <div class="form-field form-field-full">
            <label for="nbreBordereaux">Nombre maxi de bordereau par facture</label>
            <p-input-number
              id="nbreBordereaux"
              formControlName="nbreBordereaux"
              [fluid]="true"
              autocomplete="off">
            </p-input-number>
          </div>

          <!-- Montant maxi par facture -->
          <div class="form-field form-field-full">
            <label for="montantMaxParFcture">Montant maxi par facture</label>
            <p-input-number
              id="montantMaxParFcture"
              formControlName="montantMaxParFcture"
              [fluid]="true"
              autocomplete="off">
            </p-input-number>
          </div>

          <!-- Modèle de facture -->
          <div class="form-field form-field-full">
            <label for="modelFacture">Modèle de facture</label>
            <p-select
              id="modelFacture"
              formControlName="modelFacture"
              [options]="modelFacture"
              optionLabel="value"
              optionValue="key"
              placeholder="Sélectionner un modèle"
              [fluid]="true">
            </p-select>
          </div>

          @if (categorie !== 'DEPOT') {
            <!-- Exclure du CA -->
            <div class="form-field form-field-full">
              <label for="toBeExclude">Exclure du CA</label>
              <p-toggleswitch
                id="toBeExclude"
                formControlName="toBeExclude">
              </p-toggleswitch>
            </div>
          }
        </div>
      </p-card>

      <!-- Section 4: Plafonds et Remises -->
      <p-card>
        <ng-template #header>
          <div class="section-header">
            <i class="pi pi-calculator"></i>
            <span>Plafonds et Remises</span>
          </div>
        </ng-template>

        <div class="form-grid-compact">
          <!-- Remise forfaitaire -->
          <div class="form-field form-field-full">
            <label for="remiseForfaitaire">Remise forfaitaire</label>
            <p-input-number
              id="remiseForfaitaire"
              formControlName="remiseForfaitaire"
              [fluid]="true"
              autocomplete="off">
            </p-input-number>
          </div>

          <!-- Plafond consommation -->
          <div class="form-field form-field-full">
            <label for="plafondConso">Plafond consommation</label>
            <p-input-number
              id="plafondConso"
              formControlName="plafondConso"
              [fluid]="true"
              autocomplete="off">
            </p-input-number>
          </div>

          <!-- Plafond absolu -->
          <div class="form-field form-field-full">
            <label for="plafondAbsolu">Le plafond est-il absolu ?</label>
            <p-toggleswitch
              id="plafondAbsolu"
              formControlName="plafondAbsolu">
            </p-toggleswitch>
          </div>
        </div>
      </p-card>

      <!-- Section 5: Plafonds Clients (only for ASSURANCE) -->
      @if (categorie === 'ASSURANCE') {
        <p-card>
          <ng-template #header>
            <div class="section-header">
              <i class="pi pi-users"></i>
              <span>Plafonds Clients</span>
            </div>
          </ng-template>

          <div class="form-grid-compact">
            <!-- Plafond de vente des clients -->
            <div class="form-field form-field-full">
              <label for="plafondJournalierClient">Plafond de vente des clients</label>
              <p-input-number
                id="plafondJournalierClient"
                formControlName="plafondJournalierClient"
                [fluid]="true"
                autocomplete="off">
              </p-input-number>
            </div>

            <!-- Plafond consommation des clients -->
            <div class="form-field form-field-full">
              <label for="plafondConsoClient">Plafond consommation des clients</label>
              <p-input-number
                id="plafondConsoClient"
                formControlName="plafondConsoClient"
                [fluid]="true"
                autocomplete="off">
              </p-input-number>
            </div>

            <!-- Plafond absolu client -->
            <div class="form-field form-field-full">
              <label for="plafondAbsoluClient">Le plafond des clients est-il absolu ?</label>
              <p-toggleswitch
                id="plafondAbsoluClient"
                formControlName="plafondAbsoluClient">
              </p-toggleswitch>
            </div>
          </div>
        </p-card>
      }
    </div>
  </div>

  <div class="form-actions-compact">
    <p-button
      label="Annuler"
      icon="pi pi-times"
      severity="secondary"
      [text]="true"
      type="button"
      (click)="cancel()">
    </p-button>
    <p-button
      label="Enregistrer"
      icon="pi pi-check"
      severity="primary"
      type="submit"
      [disabled]="editForm.invalid || isSaving || !isValid"
      [loading]="isSaving">
    </p-button>
  </div>
</form>
<jhi-toast-alert #alert></jhi-toast-alert>
