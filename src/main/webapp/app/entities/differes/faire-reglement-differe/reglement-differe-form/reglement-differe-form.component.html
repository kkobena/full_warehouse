<form (ngSubmit)="save()" [formGroup]="reglementForm" class="reglement-differe-form">
  <!-- Header Row with Date and Back Button -->
  <div class="header-row">
    <div class="date-field">
      <p-floatlabel variant="on">
        <p-datePicker
          [defaultDate]="maxDate"
          [maxDate]="maxDate"
          [showButtonBar]="true"
          dateFormat="dd/mm/yy"
          formControlName="paymentDate"
          id="datePaiement"
          selectOtherMonths="true"
        />
        <label for="datePaiement">Date de règlement</label>
      </p-floatlabel>
    </div>

    <div class="back-button">
      <p-button (click)="previousState()" icon="pi pi-arrow-left" label="Retour" raised="true" severity="secondary" type="button" />
    </div>
  </div>

  <!-- Payment Mode -->
  <div class="form-field-full">
    <p-inputgroup>
      <p-inputgroup-addon>
        <i class="pi pi-credit-card"></i>
      </p-inputgroup-addon>
      <p-select
        [appendTo]="appendTo"
        [autofocus]="true"
        [dataKey]="'id'"
        [options]="paymentModes"
        formControlName="modePaimentCode"
        optionLabel="libelle"
        optionValue="code"
        placeholder="Sélectionner un mode de paiement"
      />
    </p-inputgroup>
  </div>

  <!-- Amount -->
  <div class="form-field-full">
    <p-inputgroup>
      <p-inputgroup-addon>
        <i class="pi pi-money-bill"></i>
      </p-inputgroup-addon>
      <p-inputNumber autocomplete="off" formControlName="amount" id="amount" placeholder="Montant" type="number" />
    </p-inputgroup>
  </div>

  <!-- Bank Information Section -->
  @if (showBanqueInfo) {
    <div class="bank-info-section" formGroupName="banqueInfo">
      <p-divider align="left">
        <div class="divider-content">
          <i class="pi pi-building"></i>
          <span>Informations bancaires</span>
        </div>
      </p-divider>

      <div class="bank-fields">
        <!-- Bank Name -->
        <div class="form-field-full">
          <p-inputgroup>
            <p-inputgroup-addon>
              <i class="pi pi-building"></i>
              <span class="addon-label">Nom</span>
            </p-inputgroup-addon>
            <input autocomplete="off" formControlName="nom" id="nom" pInputText placeholder="Nom de la banque" />
          </p-inputgroup>
          @if (
            reglementForm.get('banqueInfo').get('nom')!.invalid &&
            (reglementForm.get('banqueInfo').get('nom')!.dirty || reglementForm.get('banqueInfo').get('nom')!.touched)
          ) {
            @if (reglementForm.get('banqueInfo').get('nom')?.errors?.required) {
              <small class="p-error">Ce champ est obligatoire.</small>
            }
          }
        </div>

        <!-- Check Number (conditional) -->
        @if (reglementForm.get('modePaimentCode')!.value === CH) {
          <div class="form-field-full">
            <p-inputgroup>
              <p-inputgroup-addon>
                <i class="pi pi-hashtag"></i>
                <span class="addon-label">Numéro</span>
              </p-inputgroup-addon>
              <input autocomplete="off" formControlName="code" id="code" pInputText placeholder="Numéro de chèque" />
            </p-inputgroup>
            @if (
              reglementForm.get('banqueInfo').get('code')!.invalid &&
              (reglementForm.get('banqueInfo').get('code')!.dirty || reglementForm.get('banqueInfo').get('code')!.touched)
            ) {
              @if (reglementForm.get('banqueInfo').get('code')?.errors?.required) {
                <small class="p-error">Ce champ est obligatoire.</small>
              }
            }
          </div>
        }

        <!-- Beneficiary -->
        <div class="form-field-full">
          <p-inputgroup>
            <p-inputgroup-addon>
              <i class="pi pi-user"></i>
              <span class="addon-label">Bénéficiaire</span>
            </p-inputgroup-addon>
            <input autocomplete="off" formControlName="beneficiaire" id="beneficiaire" pInputText placeholder="Nom du bénéficiaire" />
          </p-inputgroup>
        </div>
      </div>
    </div>
  }

  <!-- Submit Button -->
  <div class="form-actions">
    <p-button
      [disabled]="!valid || !validMontantSaisi() || isSaving()"
      [loading]="isSaving()"
      icon="pi pi-check"
      label="{{ btnLabel }}"
      severity="success"
      type="submit"
    />
  </div>
</form>
