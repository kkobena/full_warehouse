<div class="container-fluid">
  <div class="row mb-3">
    <div class="col-lg-4 col-md-6 mb-1">
      <div class="card h-100 summary-card-vente">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-2 text-muted">Montant vente</h6>
              <h4
                class="card-title fw-bold">{{ factureWritable().montantVente | number: '1.0-0' }}</h4>
            </div>
            <div class="fs-2 text-success">
              <i class="pi pi-shopping-cart"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-6 mb-1">
      <div class="card h-100 summary-card-facture">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-2 text-muted">Montant facture</h6>
              <h4 class="card-title fw-bold">{{ factureWritable().montant | number: '1.0-0' }}</h4>
            </div>
            <div class="fs-2 text-primary">
              <i class="pi pi-file-text"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-6 mb-1">
      <div class="card h-100 summary-card-paye">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-2 text-muted">Montant payé</h6>
              <h4
                class="card-title fw-bold">{{ factureWritable().montantRegle | number: '1.0-0' }}</h4>
            </div>
            <div class="fs-2 text-info">
              <i class="pi pi-check-circle"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xl-7 col-lg-12 mb-1 pharma-smart ">
      <p-card class="h-100 details-card ">
        <ng-template #title>
          <div class="d-flex align-items-center gap-2 card-title primary-title">
            <i class="pi pi-list"></i>
            <span
              class="fw-bold">Détail de la facture de: {{ factureWritable().tiersPayantName }}</span>

          </div>
        </ng-template>

        <p-table
          #fact
          (onRowSelect)="onRowSelect($event.data)"
          [(selection)]="selectedFactureItem"
          [globalFilterFields]="['numBon', 'customer.fullName']"
          [paginator]="true"
          [rowsPerPageOptions]="[10, 20, 50, 100]"
          [rows]="10"
          [scrollable]="true"
          [stripedRows]="true"
          [value]="factureWritable().items"
          class="p-datatable-sm"
          dataKey="saleId"
          scrollHeight="450px"
          selectionMode="single"
        >
          <ng-template #caption>
            <div class="d-flex justify-content-start">
              <p-iconfield>
                <p-inputicon class="pi pi-search" />
                <input
                  (input)="fact.filterGlobal($event.target.value, 'contains')"
                  [(ngModel)]="searchValue"
                  class="p-inputtext-sm"
                  pInputText
                  placeholder="Filtrer..."
                  type="text"
                />
              </p-iconfield>
            </div>
          </ng-template>
          <ng-template #header>
            <tr>
              <th>Num.Bon</th>
              <th>Assuré</th>
              <th class="text-end">Total vente</th>
              <th class="text-end">Remise</th>
              <th class="text-end">Part T.P</th>
              <th class="text-end">Part Client</th>
              <th class="text-end">Montant Payé</th>
              <th class="text-end">Taux</th>
            </tr>
          </ng-template>
          <ng-template #body let-factureDetail>
            <tr [pSelectableRow]="factureDetail">
              <td>{{ factureDetail.numBon }}</td>
              <td>{{ factureDetail.customer.fullName }}</td>
              <td class="text-end">{{ factureDetail.montantVente | number: '1.0-0' }}</td>
              <td class="text-end">{{ factureDetail.montantRemise | number: '1.0-0' }}</td>
              <td class="text-end">{{ factureDetail.montant | number: '1.0-0' }}</td>
              <td class="text-end">{{ factureDetail.montantClient | number: '1.0-0' }}</td>
              <td class="text-end">{{ factureDetail.montantRegle | number: '1.0-0' }}</td>
              <td class="text-end">{{ factureDetail.taux | number }}%</td>
            </tr>
          </ng-template>
          <ng-template #empty>
            <tr>
              <td class="text-center" colspan="8">Aucun élément de facture trouvé.</td>
            </tr>
          </ng-template>
        </p-table>

      </p-card>
    </div>
    <div class="col-xl-5 col-lg-12 mb-1 pharma-smart ">
      <p-card class="h-100 details-card">
        <ng-template #title>
          <div class="d-flex align-items-center gap-2 card-title warn-title">
            <i class="pi pi-shopping-bag"></i>
            <span class="fw-bold">Détail de la vente</span>
          </div>
        </ng-template>
        @if (selectedFactureItem) {
          <div
            class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light border rounded">
            <div>
              <strong>Numéro:</strong>
              <p-tag [value]="selectedFactureItem.saleNumber" class="ms-2"></p-tag>
            </div>
            <div>
              <strong>Date:</strong>
              <span
                class="fw-semibold ms-2">{{ selectedFactureItem.created | date: 'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>
        } @else {
          <div class="text-center text-muted p-4">
            <i class="pi pi-info-circle fs-3 mb-2"></i>
            <p>Sélectionnez une ligne pour voir le détail de la vente.</p>
          </div>
        }

        <p-table [scrollable]="true" [value]="salesLines" class="p-datatable-sm"
                 scrollHeight="400px">
          <ng-template #header>
            <tr>
              <th>CIP</th>
              <th>Libellé</th>
              <th class="text-end">Qté</th>
              <th class="text-end">P.U.</th>
              <th class="text-end">Montant</th>
            </tr>
          </ng-template>
          <ng-template #body let-saleLine>
            <tr>
              <td>{{ saleLine.code }}</td>
              <td>{{ saleLine.produitLibelle }}</td>
              <td class="text-end">{{ saleLine.quantitySold | number }}</td>
              <td class="text-end">{{ saleLine.regularUnitPrice | number: '1.0-0' }}</td>
              <td class="text-end">{{ saleLine.salesAmount | number: '1.0-0' }}</td>
            </tr>
          </ng-template>
          <ng-template #empty>
            <tr>
              <td class="text-center" colspan="5">Aucun produit dans cette vente.</td>
            </tr>
          </ng-template>
        </p-table>

      </p-card>
    </div>
  </div>
</div>
