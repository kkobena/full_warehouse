<div class="container-fluid">
  <div class="pharma-smart-content p-2">
    <p-toolbar>
      <ng-template #start>
        <div class="pt-1 ml-1">
          <p-floatlabel variant="on">
            <p-datePicker
              [(ngModel)]="fromDate"
              [iconDisplay]="'input'"
              [selectOtherMonths]="true"
              [showButtonBar]="true"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              id="du"
              inputId="du"
            />
            <label for="du">Date début</label>
          </p-floatlabel>
        </div>
        <div class="pt-1 ml-1">
          <p-floatlabel variant="on">
            <p-datePicker
              [(ngModel)]="toDate"
              [iconDisplay]="'input'"
              [selectOtherMonths]="true"
              [showButtonBar]="true"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              id="au"
              inputId="du"
            />
            <label for="au">Date fin</label>
          </p-floatlabel>
        </div>
      </ng-template>
      <ng-template #end>
        <div class="pt-1 ml-1">
          <p-button class="mr-2" (click)="loadAll()" [loading]="loadingBtn()" [raised]="true" icon="pi pi-search"
                    label="Rechercher" severity="info" />
          <p-button (click)="printAll()" [loading]="loadingPdf" [raised]="true" icon="pi pi-file-pdf"
                    label="Imprimer" severity="warn" />
        </div>
      </ng-template>
    </p-toolbar>

    <div class="mt-3 row mb3 pharma-smart">
      @if (chiffreAffaire) {
        <div class="row mb-3">
          @let ca = chiffreAffaire.chiffreAffaire;
          @if (ca) {
            <div class="col">
              <p-card>
                <ng-template #title>
                  <div class="card-title primary-title">
                    <i class="pi pi-money-bill mr-2"></i>
                    Chiffre d'affaires
                  </div>
                </ng-template>
                <div class="grid">
                  <div class="col-12">

                    <div class="field">
                      <label>Montant Ttc</label>
                      <span>{{ ca.montantTtc | number }}</span>
                    </div>

                    <div class="field">
                      <label>Montant Tva</label>
                      <span>{{ ca.montantTva | number }}</span>
                    </div>
                    <div class="field">
                      <label>Montant Ht</label>
                      <span>{{ ca.montantHt | number }}</span>
                    </div>
                    <div class="field">
                      <label>Montant remise</label>
                      <span>{{ ca.montantRemise | number }}</span>
                    </div>

                    <div class="field">
                      <label>Montant net</label>
                      <span>{{ ca.montantNet | number }}</span>
                    </div>
                    <div class="field">
                      <label>Montant espèce</label>
                      <span>{{ ca.montantEspece | number }}</span>
                    </div>
                    <div class="field">
                      <label>Montant autres règlement</label>
                      <span>{{ ca.montantAutreModePaiement | number }}</span>
                    </div>
                    <div class="field">
                      <label>Montant crédit</label>
                      <span>{{ ca.montantCredit | number }}</span>
                    </div>
                    <div class="field">
                      <label>Marge</label>
                      <span>{{ ca.marge | number }}</span>
                    </div>

                  </div>
                </div>


              </p-card>

            </div>
          }
          @let achat = chiffreAffaire.achats;
          @if (achat) {
            <div class="col">
              <p-card>
                <ng-template #title>
                  <div class="card-title secondary-title">
                    <i class="pi pi-truck mr-2"></i>
                    Total des achats
                  </div>
                </ng-template>
                <div class="grid">
                  <div class="col-12">
                    <div class="field">
                      <label>Montant Ttc</label>
                      <span>{{ achat.montantTtc | number }}</span>
                    </div>

                    <div class="field">
                      <label>Montant Tva</label>
                      <span>{{ achat.montantTva | number }}</span>
                    </div>

                    <div class="field">
                      <label>Montant Ht</label>
                      <span>{{ achat.montantHt | number }}</span>
                    </div>

                  </div></div>


              </p-card>
            </div>
          }
          @let recettes = chiffreAffaire.recettes;
          @if (recettes) {
            <div class="col">
              <p-card>
                <ng-template #title>
                  <div class="card-title info-title">
                    <i class="pi pi-wallet mr-2"></i>
                    Recettes
                  </div>
                </ng-template>
                <div class="grid">
                  <div class="col-12">
                    @for (recette of recettes; track $index) {
                      <div class="field">
                        <label>{{ recette.modePaimentLibelle }}</label>
                        <span>{{ recette.montantReel | number }}</span>
                      </div>
                    }
                  </div>
                </div>

                @let total = getRecetteTotal();
                @if (total) {
                  <div class="ws-card-footer">
                    <div class="grid">
                      <div class="col-12">
                        <div class="field">
                          <label class="fs-4">Total</label>
                          <span class="fs-4">{{ total | number }}</span>
                        </div>
                      </div>
                    </div>

                  </div>
                }

              </p-card>
            </div>
          }
          @let mvts = chiffreAffaire.mouvementCaisses;
          @if (mvts) {
            <div class="col">
              <p-card>
                <ng-template #title>
                  <div class="card-title warn-title">
                    <i class="pi pi-info-circle mr-2"></i>
                    Mouvements de caisse
                  </div>
                </ng-template>
                <div class="grid">
                  <div class="col-12">
                    @for (mvt of mvts; track $index) {
                      <div class="field">
                        <label>{{ mvt.libelle }}</label>
                        <span>{{ mvt.montant | number }}</span>
                      </div>
                    }
                  </div>
                </div>

                @let totalMvts = getTotalMouvementCaisse();
                @if (totalMvts) {
                  <div class="ws-card-footer">
                    <div class="grid">
                      <div class="col-12">
                        <div class="field">
                          <label class="fs-4">Total</label>
                          <span class="fs-4">{{ totalMvts | number }}</span>
                        </div>
                      </div>
                    </div>

                  </div>
                }

              </p-card>
            </div>
          }
        </div>
      }

      @if (groupeFournisseurAchats && groupeFournisseurAchats.length) {
        <div class="row mb-3">
          <p-card>
            <ng-template #title>
              <div class="card-title primary-title">
                <i class="pi pi-building mr-2"></i>
                Achats par groupe fournisseur
              </div>
            </ng-template>

            <p-table
              #tbGroupeFournisseur
              [globalFilterFields]="['libelle']"
              [value]="groupeFournisseurAchats"
              dataKey="libelle"
              [rows]="10"
              [paginator]="true"
              [rowsPerPageOptions]="[10, 15, 20]"
            >
              <ng-template #header>
                <tr>
                  <th scope="col">Groupe fournisseur</th>
                  <th scope="col">Montant Ttc</th>
                  <th scope="col">Montant Tva</th>
                  <th scope="col">Montant Ht</th>
                </tr>
              </ng-template>
              <ng-template let-groupe #body>
                <tr>
                  <td>{{ groupe.libelle }}</td>

                  <td class="text-right">{{ groupe.montantTtc | number }}</td>
                  <td class="text-right">{{ groupe.montantTva | number }}</td>
                  <td class="text-right">{{ groupe.montantHt | number }}</td>
                </tr>
              </ng-template>
            </p-table>

          </p-card>
        </div>
      }
      @if (reglementTiersPayants && reglementTiersPayants.length) {
        <div class="row mb-3">
          <p-card>
            <ng-template #title>
              <div class="card-title info-title">
                <i class="pi pi-lightbulb mr-2"></i>
                Règlements tiers payants
              </div>
            </ng-template>

            <div class="card-body">
              <div class="table-responsive">
                <p-table
                  #tbReglementTiersPayants
                  [globalFilterFields]="['libelle']"
                  [value]="reglementTiersPayants"
                  dataKey="libelle"
                  [rows]="10"
                  [paginator]="true"
                  stripedRows="true"
                  [rowsPerPageOptions]="[10, 15, 20]"
                >
                  <ng-template #caption>
                    <div class="d-flex">
                      <p-iconfield>
                        <p-inputicon styleClass="pi pi-search" />
                        <input
                          (input)="tbReglementTiersPayants.filterGlobal($event.target.value, 'contains')"
                          pInputText
                          placeholder="Filtrer"
                          type="text"
                          [(ngModel)]="searchReglement"
                        />
                      </p-iconfield>
                    </div>
                  </ng-template>
                  <ng-template #header>
                    <tr>
                      <th scope="col">Tiers-payant</th>
                      <th scope="col">Catégorie</th>
                      <th scope="col">Numéro facture</th>
                      <th scope="col">Montant facture</th>
                      <th scope="col">Montant règlé</th>
                      <th scope="col">Montant restant</th>
                    </tr>
                  </ng-template>
                  <ng-template let-reglement #body>
                    <tr>
                      <td>{{ reglement.libelle }}</td>
                      <td>{{ reglement.type }}</td>

                      <td class="text-right">{{ reglement.factureNumber }}</td>
                      <td class="text-right">{{ reglement.montantFacture | number }}</td>
                      <td class="text-right">{{ reglement.montantReglement | number }}</td>
                      <td class="text-right">{{ reglement.montantRestant | number }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </div>

          </p-card>
        </div>
      }

      @if (achatTiersPayant && achatTiersPayant.length) {
        <div class="row">
          <p-card>
            <ng-template #title>
              <div class="card-title warn-title">
                <i class="pi pi-credit-card mr-2"></i>
                Crédits accordés
              </div>
            </ng-template>

            <div class="card-body">
              <div class="table-responsive">
                <p-table
                  #tb
                  [globalFilterFields]="['libelle']"
                  [value]="achatTiersPayant"
                  dataKey="libelle"
                  [rows]="10"
                  [paginator]="true"
                  [rowsPerPageOptions]="[10, 15, 20]"
                >
                  <ng-template #caption>
                    <div class="d-flex">
                      <p-iconfield>
                        <p-inputicon styleClass="pi pi-search" />
                        <input
                          [(ngModel)]="searchAchat"
                          (input)="tb.filterGlobal($event.target.value, 'contains')"
                          pInputText
                          placeholder="Filtrer"
                          type="text"
                        />
                      </p-iconfield>
                    </div>
                  </ng-template>
                  <ng-template #header>
                    <tr>
                      <th scope="col">Tiers-payant</th>
                      <th scope="col">Catégorie</th>
                      <th scope="col">Nombre de bon</th>
                      <th scope="col">Montant</th>
                      <th scope="col">Nombre de client</th>
                    </tr>
                  </ng-template>
                  <ng-template let-tp #body>
                    <tr>
                      <td>{{ tp.libelle }}</td>
                      <td>{{ tp.categorie }}</td>

                      <td class="text-right">{{ tp.bonsCount }}</td>
                      <td class="text-right">{{ tp.montant | number }}</td>
                      <td class="text-right">{{ tp.clientCount | number }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </div>

          </p-card>
        </div>
      }

    </div>
  </div>


</div>
