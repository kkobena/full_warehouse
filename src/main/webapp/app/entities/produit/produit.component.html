<jhi-toast-alert #alert></jhi-toast-alert>

<div class="container-fluid">
  <p-panel header="Produits">
    <p-toolbar>
      <ng-template #start>
        <div class="d-flex justify-content-between">
          <div class="mr-1">
            <p-select
              (onChange)="filtreClik()"
              [(ngModel)]="selectedCriteria"
              [options]="filtesProduits"
              optionLabel="label"
              optionValue="value"
              placeholder="Filtrer par critère"
              size="large"
              [fluid]="true"
            >
            </p-select>
          </div>
          <div class="mr-1">
            <p-select
              size="large"
              [fluid]="true"
              (onChange)="filtreRayon($event)"
              [(ngModel)]="selectedRayon"
              [options]="rayons"
              [showClear]="true"
              optionLabel="libelle"
              optionValue="id"
              placeholder="Séléctionner un rayon "
            >
            </p-select>
          </div>
          <div class="mr-1">
            <p-select
              (onChange)="filtreFamilleProduit($event)"
              [(ngModel)]="selectedFamille"
              [options]="familles"
              [showClear]="true"
              size="large"
              [fluid]="true"
              optionLabel="libelle"
              optionValue="id"
              placeholder="Séléctionner une famille"
            >
            </p-select>
          </div>
          <div>
            <p-iconfield>
              <p-inputicon styleClass="pi pi-search" />
              <input (keyup.enter)="onSearch($event)" pInputText placeholder="Taper pour rechercher"
                     type="text" />
            </p-iconfield>
          </div>
        </div>
      </ng-template>
      <ng-template #end>
        <p-splitbutton
          [model]="splitbuttons"
          [raised]="true"
          icon="pi pi-upload"
          label="Importation"
          severity="help"
          styleClass=" mr-1 mb-2"
        ></p-splitbutton>
        <p-button
          [raised]="true"
          [routerLink]="['/produit/new']"
          class="mb-2"
          icon="pi pi-plus"
          label="Nouveau"
          severity="success"
          type="button"
        >
        </p-button>
      </ng-template>
    </p-toolbar>

    <div class="mt-2">
      @if (produits && produits.length > 0) {
        <p-table [rowExpandMode]="rowExpandMode" [value]="produits" dataKey="id">
          <ng-template #header>
            <tr>
              <th style="width:2rem"></th>
              <th style="width: 8%">Cip</th>
              <th style="width: 11%">Code EAN</th>
              <th style="width: 24%"><span jhiTranslate="warehouseApp.produit.libelle">Libelle</span>
              </th>
              <th style="text-align: right; width: 6%"><span
                jhiTranslate="warehouseApp.produit.quantity">Quantity</span></th>

              <th style="text-align: right; width: 8%"><span
                jhiTranslate="warehouseApp.produit.costAmount">Prix achat </span></th>
              <th style="text-align: right; width: 8%"><span
                jhiTranslate="warehouseApp.produit.regularUnitPrice">Regular Unit Price</span></th>
              <th style="text-align: right; width: 6%">Qté.Reap</th>
              <th style="text-align: right; width: 6%">Qté Mini</th>
              <th style="width: 7%; text-align: center">Status</th>
              <th style="width: 13%"></th>
            </tr>
          </ng-template>
          <ng-template let-expanded="expanded" let-produit #body>
            <tr>
              <td>
                <p-button
                  [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                  [pRowToggler]="produit"
                  [rounded]="true"
                  [text]="true"
                  type="button"
                />
              </td>
              <td>{{ produit.codeCip }}</td>
              <td>{{ produit.codeEan }}</td>
              <td>{{ produit.libelle }}</td>
              @if (produit.totalQuantity < 0) {
                <td style="text-align: right"
                    class="amount-column red-400">{{ produit.totalQuantity | number }}
                </td>
              } @else if (produit.totalQuantity === 0) {
                <td style="text-align: right"
                    class="amount-column orange-400">{{ produit.totalQuantity | number }}
                </td>
              } @else {
                <td style="text-align: right"
                    class="amount-column">{{ produit.totalQuantity | number }}
                </td>
              }

              <td style="text-align: right">{{ produit.costAmount | number }}</td>
              <td style="text-align: right">{{ produit.regularUnitPrice | number }}</td>
              <td style="text-align: right">{{ produit.qtyAppro | number }}</td>
              <td style="text-align: right">{{ produit.qtySeuilMini | number }}</td>
              <td>
                <jhi-eta-produit [etatProduit]="produit.etatProduit"
                                 [showLabel]="false"></jhi-eta-produit>
              </td>
              <td class="text-right">
                <p-buttonGroup>
                  <p-button
                    tooltipPosition="left"
                    [routerLink]="['/produit', produit.id, 'view']"
                    severity="info"
                    icon="pi pi-eye"
                    pTooltip="Voir détail"
                    [rounded]="true"
                    [text]="true"
                    type="button"
                  >
                  </p-button>

                  @if (produit.typeProduit === 'PACKAGE') {
                    <p-button
                      tooltipPosition="left"
                      [routerLink]="['/produit', produit.id, 'edit']"
                      severity="success"
                      icon="pi pi-pencil"
                      pTooltip="Editer"
                      [rounded]="true"
                      [text]="true"
                      type="button"
                    >
                    </p-button>
                  }
                  @if (produit.typeProduit === 'DETAIL') {
                    <p-button
                      tooltipPosition="left"
                      (click)="editDetail(produit)"
                      severity="primary"
                      icon="pi pi-pencil"
                      pTooltip="Editer"
                      [rounded]="true"
                      [text]="true"
                      type="button"
                    >
                    </p-button>
                  }

                  <p-button
                    (click)="addPrixReference(produit)"
                    severity="secondary"
                    [rounded]="true"
                    [text]="true"
                    tooltipPosition="left"
                    type="button"
                    icon="pi pi-cart-plus"
                    pTooltip="Ajouter des prix de référence"
                  >
                  </p-button>


                  <p-button
                    (click)="addPeremptionDate(produit)"
                    severity="help"
                    [rounded]="true"
                    [text]="true"
                    tooltipPosition="left"
                    type="button"
                    icon="pi pi-calendar-plus"
                    pTooltip="Modifier la date de péremption"
                  >
                  </p-button>



                  @if (produit.deconditionnable && produit.produits?.length == 0) {
                    <p-button
                      (click)="addDetail(produit)"
                      severity="help"
                      tooltipPosition="left"
                      icon="pi pi-plus"
                      pTooltip="Ajouter un détail"
                      [rounded]="true"
                      [text]="true"
                      type="button"
                    >
                    </p-button>
                  }
                  @if (produit.deconditionnable) {
                    <p-button
                      (click)="decondition(produit)"
                      severity="secondary"
                      [rounded]="true"
                      [text]="true"
                      tooltipPosition="left"
                      type="button"
                      icon="pi pi-wrench"
                      pTooltip="Déconditionner"
                    >
                    </p-button>
                  }

                  <p-button
                    tooltipPosition="left"
                    (click)="confirmDelete(produit)"
                    severity="danger"
                    [rounded]="true"
                    [text]="true"
                    icon="pi pi-trash"
                    pTooltip="Supprimer"
                  >
                  </p-button>
                </p-buttonGroup>
              </td>
            </tr>
          </ng-template>
          <ng-template let-elRow #expandedrow>
            <tr>
              <td colspan="11">
                <div class="p-3  expanded-content">
                  <div class="row">
                    <div class="mb-3 col-md-12 col-sm-12 col-lg-6 col-xl-4 col-xxl-4">
                      <p-card>
                        <ng-template #title>
                          <div class="card-title pharma-smart-card-title primary-title ">
                            <i class="pi pi-info-circle mr-2"></i>
                            Informations Générales
                          </div>
                        </ng-template>
                        <div class="grid">
                          <div class="col-12">
                            <div class="field">
                              <label>PMP</label>
                              <span>{{ elRow?.prixMnp | number }}</span>
                            </div>
                            <div class="field">
                              <label>Date dernière vente</label>
                              <span>{{ elRow?.lastDateOfSale | date: 'dd/MM/yyyy HH:mm' }}</span>
                            </div>
                            <div class="field">
                              <label>Date de création</label>
                              <span>{{ elRow?.createdAt | date: 'dd/MM/yyyy HH:mm' }}</span>
                            </div>
                            <div class="field">
                              <label>Date péremption</label>
                              <span>{{ elRow?.expirationDate }}</span>
                            </div>
                            <div class="field">
                              <label>Gamme</label>
                              <span>{{ elRow?.gammeLibelle }}</span>
                            </div>
                            <div class="field">
                              <label>Date dernière entrée en stock</label>
                              <span>{{ elRow?.lastOrderDate | date: 'dd/MM/yyyy HH:mm' }}</span>
                            </div>
                            <div class="field">
                              <label>Date dernière inventaire</label>
                              <span>{{ elRow?.lastInventoryDate | date: 'dd/MM/yyyy HH:mm' }}</span>
                            </div>
                            <div class="field">
                              <label>Tva</label>
                              <span>{{ elRow?.tvaTaux }}</span>
                            </div>
                            <div class="field">
                              <label>Quantité détail</label>
                              <span>{{ elRow?.itemQty }}</span>
                            </div>
                            <div class="field">
                              <label>Famille</label>
                              <span>{{ elRow?.familleLibelle }}</span>
                            </div>
                            <div class="field">
                              <label>Forme</label>
                              <span>{{ elRow?.formeLibelle }}</span>
                            </div>
                            <div class="field">
                              <label>Laboratoire</label>
                              <span>{{ elRow?.laboratoireLibelle }}</span>
                            </div>
                          </div>
                        </div>
                      </p-card>
                    </div>

                    <div class="col-md-6 col-sm-12 col-lg-6 col-xl-8 col-xxl-8 row">
                      <div class="mb-3 col-md-6 col-sm-12 col-lg-6 col-xl-6 col-xxl-6">
                        <p-card>
                          <ng-template #title>
                            <div class="card-title warn-title">
                              <i class="pi pi-sitemap mr-2"></i>
                              Gestion des Rayons
                            </div>
                          </ng-template>
                          <p-table [value]="elRow?.rayonProduits">
                            <ng-template #header>
                              <tr>
                                <th>Code rayon</th>
                                <th>Libelle rayon</th>
                                @if (!isMono) {
                                  <th>Stockage</th>
                                }
                                @if (!isMono) {
                                  <th style="text-align: right">
                                    <p-button
                                      [text]="true"
                                      rounded="true"
                                      icon="pi pi-plus"
                                      severity="primary"
                                      pTooltip="Ajouter un rayon"
                                    ></p-button>
                                  </th>
                                }
                              </tr>
                            </ng-template>
                            <ng-template #body let-rayon>
                              <tr>
                                <td>{{ rayon.codeRayon }}</td>
                                <td>{{ rayon.libelleRayon }}</td>
                                @if (!isMono) {
                                  <td>{{ rayon.libelleStorage }}</td>
                                }
                                @if (!isMono) {
                                  <td style="text-align: right">
                                    <p-button
                                      class="mb-2"
                                      [text]="true"
                                      icon="pi pi-trash"
                                      [rounded]="true"
                                      severity="danger"
                                      pTooltip="Supprimer"
                                    ></p-button>
                                  </td>
                                }
                              </tr>
                            </ng-template>
                            <ng-template #emptymessage>
                              <tr>
                                <td [attr.colspan]="!isMono ? 4 : 2">Aucun rayon.</td>
                              </tr>
                            </ng-template>
                          </p-table>
                        </p-card>
                      </div>
                      <div class="mb-3 col-md-6 col-sm-12 col-lg-6 col-xl-6 col-xxl-6">
                        <p-card>
                          <ng-template #title>
                            <div class="card-title info-title">
                              <i class="pi pi-cog mr-2"></i>
                              Liste des fournisseurs
                            </div>

                          </ng-template>
                          <p-table [value]="elRow?.fournisseurProduits">
                            <ng-template #header>
                              <tr>
                                <th>Grossiste</th>
                                <th>Cip</th>
                                <th>Prix.A</th>
                                <th>Prix.U</th>
                                <th style="text-align: right">
                                  <p-button
                                    (click)="addFournisseur(elRow)"
                                    severity="info"
                                    size="small"
                                    [rounded]="true"
                                    [text]="true"
                                    icon="pi pi-plus"
                                    pTooltip="Ajouter un fournisseur"
                                  ></p-button>
                                </th>
                              </tr>
                            </ng-template>
                            <ng-template #body let-four>
                              <tr>
                                <td>{{ four.fournisseurLibelle }}</td>
                                <td>{{ four.codeCip }}</td>
                                <td>{{ four.prixAchat | number }}</td>
                                <td>{{ four.prixUni | number }}</td>
                                <td style="text-align: right">
                                  <p-toggleswitch [disabled]="four.principal"
                                                  (onChange)="onChangeDefaultProduitFournisseur($event, four)"
                                                  [(ngModel)]="four.principal"
                                                  [pTooltip]="getToolTip(four)"
                                  >
                                  </p-toggleswitch>
                                  <p-button
                                    (click)="editFournisseur(elRow, four)"
                                    [rounded]="true"
                                    [text]="true"
                                    size="small"
                                    severity="success"
                                    class="p-mr-2 p-ml-2"
                                    icon="pi pi-pencil"
                                    pTooltip="Editer"
                                  ></p-button>
                                  <p-button
                                    (click)="confirmDeleteProduitFournisseur(four, elRow)"
                                    icon="pi pi-trash"
                                    severity="danger"
                                    size="small"
                                    [rounded]="true"
                                    [text]="true"
                                    pTooltip="Supprimer"
                                  ></p-button>
                                </td>
                              </tr>
                            </ng-template>
                            <ng-template #emptymessage>
                              <tr>
                                <td colspan="5">Aucun fournisseur.</td>
                              </tr>
                            </ng-template>
                          </p-table>
                        </p-card>
                      </div>

                      @if (!isMono) {
                        <div class=" col-md-6 col-sm-12 col-lg-6 col-xl-6 col-xxl-6">
                          <p-card>
                            <ng-template #title>
                              <div class="card-title secondary-title">
                                <i class="pi pi-cog mr-2"></i>
                                Répartition du stock
                              </div>

                            </ng-template>
                            <p-table [value]="elRow?.stockProduits">

                              <ng-template #header>
                                <tr>
                                  <th>Stockage</th>
                                  <th>Stock</th>
                                  <th style="text-align: right">
                                    <p-button size="small" icon="pi pi-plus" severity="primary" [rounded]="true"
                                              [text]="true" pTooltip="Repartir le stock"></p-button>
                                  </th>
                                </tr>
                              </ng-template>
                              <ng-template #body let-stock>
                                <tr>
                                  <td>{{ stock.storageName }}</td>
                                  <td>{{ stock.qtyStock | number }}</td>
                                  <td style="text-align: right">
                                    <p-button
                                      class="mr-2"
                                      icon="pi pi-pencil"
                                      severity="success"
                                      [rounded]="true"
                                      [text]="true"
                                    ></p-button>
                                    <p-button icon="pi pi-trash" [text]="true" severity="danger"
                                              [rounded]="true"></p-button>
                                  </td>
                                </tr>
                              </ng-template>
                              <ng-template #emptymessage>
                                <tr>
                                  <td colspan="3">Aucun stock.</td>
                                </tr>
                              </ng-template>
                            </p-table>
                          </p-card>
                        </div>
                      }
                    </div>

                  </div>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
        <div class="mt-2">
          <div class="d-flex justify-content-center">
            <ngb-pagination
              (pageChange)="loadPage($event)"
              [(page)]="ngbPaginationPage"
              [boundaryLinks]="true"
              [collectionSize]="totalItems"
              [maxSize]="5"
              [pageSize]="itemsPerPage"
              [rotate]="true"
            ></ngb-pagination>
          </div>
        </div>
      } @else {
        <div class="alert alert-warning" id="no-result">
          <span jhiTranslate="warehouseApp.produit.home.notFound">No produits found</span>
        </div>
      }
    </div>
  </p-panel>


</div>
<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>
<jhi-spinner #spinner ></jhi-spinner>
