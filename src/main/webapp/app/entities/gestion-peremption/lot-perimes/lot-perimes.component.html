<div class="pharma-smart-content">
  <!-- Modern Pharma Toolbar (Compact) -->
  <div class="pharma-toolbar pharma-toolbar-compact">
    <div class="pharma-toolbar-header">
      <i class="pi pi-calendar-times"></i>
      <span class="pharma-toolbar-title">Lots périmés</span>
    </div>

    <p-toolbar>
      <ng-template #start>
        <div class="pharma-toolbar-filters">
          <p-select
            (onChange)="onFilterChange()"
            [(ngModel)]="selectedType"
            [options]="types"
            [style]="{ 'min-width': '100px' }"
            optionLabel="label"
          ></p-select>

          <p-floatlabel variant="on" [style]="{ 'min-width': '90px' }">
            <p-iconfield>
              <p-inputicon class="pi pi-search" />
              <input
                (keyup.enter)="onSearch()"
                [(ngModel)]="searchTerm"
                [style]="{ 'max-width': '200px' }"
                id="searchTerm"
                pInputText
                type="text"
            /></p-iconfield>
            <label for="searchTerm">{{ 'warehouseApp.labels.searchPlaceholder' | translate }}</label>
          </p-floatlabel>

          <p-floatlabel variant="on" [style]="{ 'min-width': '90px' }">
            <input
              (keyup.enter)="onSearch()"
              [(ngModel)]="dayCount"
              [style]="{ 'max-width': '120px' }"
              autocomplete="off"
              id="dayCount"
              pInputText
              pKeyFilter="int"
              type="text"
            />
            <label for="dayCount">{{ 'warehouseApp.labels.dayCount' | translate }}</label>
          </p-floatlabel>

          <jhi-date-picker
            [(ngModel)]="fromDate"
            [id]="'dateDebut'"
            [label]="'warehouseApp.labels.du'"
            [style]="{ 'max-width': '140px' }"
          ></jhi-date-picker>

          <jhi-date-picker
            [(ngModel)]="toDate"
            [id]="'dateFin'"
            [label]="'warehouseApp.labels.au'"
            [style]="{ 'max-width': '140px' }"
          ></jhi-date-picker>

          @if (!isMono) {
            <p-floatlabel variant="on" [style]="{ 'min-width': '90px' }">
              <p-select
                (onChange)="onMagasinChange()"
                [(ngModel)]="selectedMagasin"
                [options]="magasins"
                [showClear]="true"
                [fluid]="true"
                appendTo="body"
                id="magasins"
                optionLabel="fullName"
              ></p-select>
              <label for="magasins">{{ 'warehouseApp.labels.magasin' | translate }}</label>
            </p-floatlabel>
            <p-floatlabel variant="on" [style]="{ 'min-width': '90px' }">
              <p-select
                [fluid]="true"
                (onChange)="onStorageChange()"
                [(ngModel)]="selectedStorage"
                [options]="storages"
                [showClear]="true"
                appendTo="body"
                id="storages"
                optionLabel="name"
              ></p-select>
              <label for="storages">{{ 'warehouseApp.labels.typeStockage' | translate }}</label>
            </p-floatlabel>
          }
          <p-floatlabel variant="on" [style]="{ 'min-width': '90px' }">
            <p-select
              [fluid]="true"
              (onChange)="onSearch()"
              [(ngModel)]="selectedRayon"
              [options]="rayons"
              [showClear]="true"
              [style]="{ 'min-width': '200px' }"
              filter="true"
              appendTo="body"
              id="rayons"
              optionLabel="libelle"
              size="large"
            ></p-select>
            <label for="rayons">{{ 'warehouseApp.labels.rayons' | translate }}</label>
          </p-floatlabel>
          <p-floatlabel variant="on" [style]="{ 'min-width': '90px' }">
            <p-select
              (onChange)="onSearch()"
              [(ngModel)]="selectedFournisseur"
              [fluid]="true"
              [options]="fournisseurs"
              [showClear]="true"
              [style]="{ 'min-width': '200px' }"
              filter="true"
              appendTo="body"
              id="fournisseurs"
              optionLabel="libelle"
              size="large"
            ></p-select>
            <label for="fournisseurs">{{ 'warehouseApp.labels.fournisseurs' | translate }}</label>
          </p-floatlabel>
        </div>
      </ng-template>

      <ng-template #end>
        <div class="pharma-toolbar-actions">
          <div class="pharma-button-group">
            <p-button
              (click)="onSearch()"
              [raised]="true"
              icon="pi pi-search"
              label="{{ 'warehouseApp.buttons.search' | translate }}"
              severity="info"
              type="button"
            ></p-button>

            <p-button
              [raised]="true"
              [routerLink]="['/gestion-peremption', 'edit']"
              icon="pi pi-plus"
              label="{{ 'warehouseApp.buttons.add' | translate }}"
              severity="success"
              type="button"
            ></p-button>

            <p-splitbutton
              [model]="exportMenus"
              [raised]="true"
              icon="pi pi-download"
              label="{{ 'warehouseApp.buttons.export' | translate }}"
              severity="help"
            ></p-splitbutton>

            @if (selectedLotPerimes?.length > 1) {
              <p-button
                (click)="confirmAll()"
                [raised]="true"
                icon="pi pi-trash"
                label="{{ 'warehouseApp.buttons.removeAllStock' | translate }}"
                severity="danger"
                type="button"
              ></p-button>
            }
          </div>
        </div>
      </ng-template>
    </p-toolbar>
  </div>

  <p-divider></p-divider>
  @if (lotPerimeValeurSum) {
    <div class="row g-4 mb-2">
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card h-100 shadow-sm text-center border rounded-3 bg-danger-subtle">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <span class="fw-medium fs-6 text-danger">{{ 'warehouseApp.gestionPerimes.labels.produitPerimes' | translate }}</span>
              <span class="fw-bold fs-3">{{ lotPerimeValeurSum.count | number }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="fw-medium fs-6 text-danger">{{ 'warehouseApp.gestionPerimes.labels.quantitesProduit' | translate }}</span>
              <span class="fw-bold fs-3">{{ lotPerimeValeurSum.quantite | number }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card h-100 shadow-sm text-center border rounded-3 bg-warning-subtle">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <span class="fw-medium fs-6 text-warning">{{ 'warehouseApp.gestionPerimes.labels.valeursAchat' | translate }}</span>
              <span class="fw-bold fs-3">{{ lotPerimeValeurSum.valeurAchat | number }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="fw-medium fs-6 text-warning">{{ 'warehouseApp.gestionPerimes.labels.valeursVente' | translate }}</span>
              <span class="fw-bold fs-3">{{ lotPerimeValeurSum.valeurVente | number }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card h-100 shadow-sm text-center border rounded-3 bg-primary-subtle">
          <div class="card-body">
            <h5 class="card-title text-primary">
              {{
                'warehouseApp.gestionPerimes.labels.prochainesPerimes'
                  | translate
                    : {
                        date: '30j',
                      }
              }}
            </h5>
            <p class="card-text fs-3 fw-bold">{{ lotPerimeValeurSum.prochainesPerimes | number }}</p>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card h-100 shadow-sm text-center border rounded-3 bg-success-subtle">
          <div class="card-body">
            <h5 class="card-title text-success">{{ 'warehouseApp.gestionPerimes.labels.retours' | translate }}</h5>
            <p class="card-text fs-3 fw-bold">{{ lotPerimeValeurSum.retoursFourn | number }}</p>
          </div>
        </div>
      </div>
    </div>
  }
  @if (data && data.length) {
    <div>
      <p-table
        (onLazyLoad)="lazyLoading($event)"
        [(selection)]="selectedLotPerimes"
        [lazy]="true"
        [loading]="loading"
        [paginator]="true"
        [rowsPerPageOptions]="[10, 15, 20, 30, 50]"
        [rows]="itemsPerPage"
        [showCurrentPageReport]="false"
        [showGridlines]="true"
        [totalRecords]="totalItems"
        [value]="data"
        class="pharma-table"
        dataKey="id"
        selectionMode="multiple"
      >
        <ng-template #header>
          <tr class="pharma-table-head">
            <th>Libellé produit</th>
            <th>Code produit</th>
            <th>Numéro lot</th>
            <th>Date de péremption</th>
            <th>Quantité</th>
            <th>Prix.Achat</th>
            <th>Prix.vente</th>
            <th>Statut</th>
            <th>Fournisseur</th>
            <th>Rayon</th>
            <th class="table-all-checkbos">
              <p-tableHeaderCheckbox #checkbox></p-tableHeaderCheckbox>
            </th>
            <th></th>
          </tr>
        </ng-template>
        <ng-template #body let-data>
          <tr>
            <td class="pharma-product-name">
              {{ data.produitName }}
            </td>

            <td class="pharma-code">
              {{ data.produitCode }}
            </td>
            <td class="pharma-code">
              {{ data.numLot }}
            </td>
            <td>
              {{ data.datePeremption }}
            </td>
            <td class="text-right amount-column">
              <span class="pharma-qty-value">{{ data.quantity | number }}</span>
            </td>
            <td class="text-right amount-column">
              <span class="pharma-price">{{ data.prixAchat | number }}</span>
            </td>
            <td class="text-right amount-column">
              <span class="pharma-price">{{ data.prixVente | number }}</span>
            </td>
            <td class="text-center">
              <p-tag [severity]="getSeverity(data.peremptionStatut)" [value]="data.peremptionStatut.libelle" />
            </td>
            <td class="pharma-entity-name">
              {{ data.fournisseur }}
            </td>
            <td class="pharma-entity-name">
              {{ data.rayonName }}
            </td>
            <td class="text-center">
              <p-tableCheckbox [value]="data"></p-tableCheckbox>
            </td>
            <td class="text-right">
              <div class="btn-group">
                <jhi-remove-tex-button (click)="confirmRetirerDialog(data)"></jhi-remove-tex-button>
                <jhi-cta
                  (click)="confirmRetirerDialog(data)"
                  [isText]="true"
                  [raised]="false"
                  [tooltip]="'warehouseApp.buttons.retourFournisseur'"
                  icon="pi pi-reply"
                  severity="info"
                ></jhi-cta>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  } @else {
    <div class="alert alert-warning" id="no-result">
      <span>{{ 'global.messages.emptyData' | translate }}</span>
    </div>
  }
</div>
<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>
<jhi-toast-alert #alert></jhi-toast-alert>

<jhi-spinner #spinner></jhi-spinner>
