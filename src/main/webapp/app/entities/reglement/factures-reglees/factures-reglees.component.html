<div class="pharma-smart-content">
  <!-- Modern Pharma Toolbar (Compact) -->
  <div class="pharma-toolbar pharma-toolbar-compact">
    <div class="pharma-toolbar-header">
      <i class="pi pi-check-circle"></i>
      <span class="pharma-toolbar-title">Factures réglées</span>
    </div>

    <p-toolbar>
      <ng-template #start>
        <div class="pharma-toolbar-filters">
          <div class="mr-1 d-flex align-items-center">
            <label class="input-label me-1">Groupés</label>
            <p-toggleswitch (onChange)="onSearch()" [(ngModel)]="factureGroup" />
          </div>

          <p-floatlabel variant="on" class="mr-1">
            <input [(ngModel)]="search" pInputText id="searchInput" type="text" style="width: 180px" />
            <label for="searchInput">Taper pour rechercher</label>
          </p-floatlabel>

          <p-floatlabel variant="on" class="mr-1">
            <p-datePicker
              [(ngModel)]="modelStartDate"
              [iconDisplay]="'input'"
              [selectOtherMonths]="true"
              [showButtonBar]="true"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              id="fromDate"
              inputId="fromDate"
              appendTo="body"
            />
            <label for="fromDate">Du</label>
          </p-floatlabel>

          <p-floatlabel variant="on" class="mr-1">
            <p-datePicker
              [(ngModel)]="modelEndDate"
              [iconDisplay]="'input'"
              [selectOtherMonths]="true"
              [showButtonBar]="true"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              id="toDate"
              inputId="toDate"
              appendTo="body"
            />
            <label for="toDate">Au</label>
          </p-floatlabel>

          @if (factureGroup) {
            <p-floatlabel variant="on" class="mr-1">
              <p-autoComplete
                (completeMethod)="searchGroupTiersPayant($event)"
                [(ngModel)]="selectedGroupeTiersPayant"
                [forceSelection]="true"
                [multiple]="false"
                [suggestions]="groupeTiersPayants"
                appendTo="body"
                id="groupeTiersPayants"
                inputId="groupeTiersPayants"
                optionLabel="name"
              />
              <label for="groupeTiersPayants">Rechercher un groupe</label>
            </p-floatlabel>
          } @else {
            <p-floatlabel variant="on" class="mr-1">
              <p-autoComplete
                (completeMethod)="searchTiersPayant($event)"
                [(ngModel)]="selectedTiersPayant"
                [forceSelection]="true"
                [minQueryLength]="minLength"
                [multiple]="false"
                [suggestions]="tiersPayants"
                appendTo="body"
                id="tiersPayantId"
                inputId="tiersPayantId"
                optionLabel="fullName"
              />
              <label for="tiersPayantId">Rechercher tiers-payants</label>
            </p-floatlabel>
          }
        </div>
      </ng-template>

      <ng-template #end>
        <div class="pharma-toolbar-actions">
          <div class="pharma-button-group">
            <p-button
              (click)="onSearch()"
              [loading]="loadingBtn"
              [raised]="true"
              icon="pi pi-search"
              label="Rechercher"
              pTooltip="Rechercher"
              severity="info"
              tooltipPosition="top"
            />

            <p-button
              (click)="onPrintPdf()"
              [loading]="loadingPdf"
              [raised]="true"
              icon="pi pi-file-pdf"
              label="Imprimer"
              pTooltip="Imprimer"
              severity="warn"
              tooltipPosition="top"
            />
          </div>
        </div>
      </ng-template>
    </p-toolbar>
  </div>
  <div class="row px-2">
    <p-table
      #factureDossierTable
      [(selection)]="selectedDatas"
      [expandedRowKeys]="expandedRows"
      [globalFilterFields]="['organisme', 'codeFacture']"
      [paginator]="true"
      [rowsPerPageOptions]="[10, 15, 20, 25, 30, 100]"
      [rows]="15"
      [scrollHeight]="scrollHeight"
      [scrollable]="true"
      [showCurrentPageReport]="true"
      [stripedRows]="true"
      [value]="datas"
      class="pharma-table"
      currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} règlements"
      dataKey="id"
      groupRowsBy="organismeId"
      rowGroupMode="subheader"
      selectionMode="multiple"
      sortField="organisme"
      sortMode="single"
    >
      <ng-template #caption>
        <div class="d-flex justify-content-between">
          <div class="p-0">
            <p-iconfield>
              <p-inputicon class="pi pi-search" />
              <input
                (input)="factureDossierTable.filterGlobal($event.target.value, 'contains')"
                [style]="{ width: '300px' }"
                pInputText
                placeholder="Taper pour filter "
                type="text"
              />
            </p-iconfield>
          </div>

          <div class="p-0">
            @if (selectedDatas?.length > 0) {
              <p-button
                (click)="onRemoveAll()"
                [loading]="removeAll"
                [raised]="true"
                icon="pi pi-trash"
                label="Tout supprimer"
                severity="danger"
              />
            }
          </div>
        </div>
      </ng-template>
      <ng-template #header>
        <tr class="pharma-table-head">
          <th>Organisme</th>
          <th>Code facture</th>
          <th>Mode règlement</th>
          <th>Montant Att</th>
          <th>Montant règlé</th>
          <th>Montant Restant</th>
          <th>Date</th>
          <th>Opérateur</th>
          <th></th>
          <ng-container>
            <th class="table-all-checkbos">
              <p-tableHeaderCheckbox #checkbox></p-tableHeaderCheckbox>
            </th>
          </ng-container>
        </tr>
      </ng-template>
      <ng-template #groupheader let-expanded="expanded" let-reglement let-rowIndex="rowIndex">
        <tr>
          <td colspan="4">
            <p-button
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              [pRowToggler]="reglement"
              [rounded]="true"
              [text]="true"
              type="button"
            />
            <span class="font-bold ml-2 group-title">{{ reglement.organisme }}</span>
          </td>
          <td class="text-right">
            <span class="font-bold ml-2 group-title total-group text-right">{{
              'Total: ' + getTotalAmountByGroup(reglement.organismeId)
            }}</span>
          </td>
          <td colspan="5"></td>
        </tr>
      </ng-template>

      <ng-template #expandedrow let-reglement>
        <tr>
          <td class="text-center" colspan="2">
            <span class="pharma-code">{{ reglement.codeFacture }}</span>
          </td>
          <td>
            <span class="pharma-badge pharma-badge-info">{{ reglement.paymentMode }}</span>
          </td>

          <td class="pharma-price">
            {{ reglement.montantAttendu }}
          </td>
          <td class="pharma-total">
            {{ reglement.paidAmount }}
          </td>
          <td class="pharma-price">
            {{ reglement.montantRestant }}
          </td>
          <td class="text-center">{{ reglement.created }}</td>
          <td>{{ reglement.user }}</td>
          <td class="text-right">
            <p-button (click)="onView(reglement)" [rounded]="true" [text]="true" icon="pi pi-eye" severity="info"></p-button>
            <p-button (click)="onPrint(reglement)" [rounded]="true" [text]="true" icon="pi pi-print" severity="secondary"></p-button>
            <p-button
              (click)="onDelete(reglement)"
              [rounded]="true"
              [text]="true"
              icon="pi pi-trash"
              severity="danger"
              styleClass="p-button-danger"
            ></p-button>
          </td>
          <td class="text-center">
            <p-tableCheckbox [value]="reglement"></p-tableCheckbox>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>
