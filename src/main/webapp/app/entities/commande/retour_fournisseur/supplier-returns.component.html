<div class="container-fluid">
  <p-toast />
<div class="pharma-smart-content">
  <!-- Pharma Toolbar Header -->
  <div class="pharma-toolbar">
    <div class="pharma-toolbar-header">
      <i class="pi pi-replay"></i>
      <span class="pharma-toolbar-title">Gestion des Retours Fournisseur</span>
      <div class="ms-auto">
        <p-button
          icon="pi pi-arrow-left"
          label="Retour à la liste"
          severity="primary"
          [outlined]="true"
          (onClick)="navigateToList()"
          size="small"
        />
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <!-- Order Line Selection with AutoComplete -->
      <div class="mb-4">
        <h5 class="mb-3">Ajouter une ligne de retour</h5>
        <div class="card">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <p-floatlabel>
                  <p-autoComplete
                    #orderSelect
                    [(ngModel)]="selectedCommande"
                    [suggestions]="filteredCommandes()"
                    (completeMethod)="searchCommandes($event)"
                    (onSelect)="onCommandeChange()"
                    [dataKey]="'id'"
                    [forceSelection]="true"
                    [minQueryLength]="1"
                    [showEmptyMessage]="true"
                    [emptyMessage]="'Aucune commande trouvée'"
                    optionLabel="orderReference"
                    [showClear]="true"
                    inputId="order-select"
                    class="w-100"
                  >
                    <ng-template let-commande #item>
                      <div>
                        <div>{{ commande.receiptReference }}</div>
                        <small class="text-muted">Date: {{ commande.orderDate | date: 'dd/MM/yyyy' }}</small>
                      </div>
                    </ng-template>
                  </p-autoComplete>
                  <label for="order-select">Rechercher une commande</label>
                </p-floatlabel>
              </div>

              <div class="col-md-4">
                <p-floatlabel>
                  <p-autoComplete
                    #orderLineAutoComplete
                    [(ngModel)]="selectedOrderLine"
                    [suggestions]="filteredOrderLines()"
                    (completeMethod)="searchOrderLines($event)"
                    (onSelect)="onOrderLineSelect()"
                    [dataKey]="'id'"
                    [forceSelection]="true"
                    [minQueryLength]="1"
                    [showEmptyMessage]="true"
                    [emptyMessage]="'Aucune ligne de commande trouvée'"
                    optionLabel="produitLibelle"
                    [showClear]="true"
                    [disabled]="!selectedCommande()"
                    inputId="order-line-search"
                    class="w-100"
                  >
                    <ng-template let-orderLine #item>
                      <div class="d-flex justify-content-between align-items-center w-100">
                        <div class="flex-grow-1">
                          <div>
                            <span class="pharma-code me-2">{{ orderLine.produitCip }}</span>
                            <span>{{ orderLine.produitLibelle }}</span>
                          </div>
                          <small class="text-muted">
                            Commandé: {{ orderLine.quantityRequested | number }} |
                            Reçu: {{ orderLine.quantityReceived | number }}
                          </small>
                        </div>
                      </div>
                    </ng-template>
                  </p-autoComplete>
                  <label for="order-line-search">Rechercher une ligne de commande</label>
                </p-floatlabel>
              </div>

              <div class="col-md-4">
                <p-floatlabel>
                  <p-inputNumber
                    [(ngModel)]="returnQuantity"
                    [min]="1"
                    [max]="getSelectedOrderLineMaxQuantity()"
                    [showButtons]="true"
                    [disabled]="!selectedOrderLine()"
                    inputId="return-quantity"
                    class="w-100"
                  />
                  <label for="return-quantity">Quantité à retourner</label>
                </p-floatlabel>
              </div>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-12">
                <p-button
                  label="Ajouter"
                  icon="pi pi-plus"
                  severity="success"
                  [disabled]="!selectedOrderLine() || returnQuantity() < 1"
                  (onClick)="addReturnLine()"
                  class="w-100"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Return Lines Table -->
      @if (retourBonItems().length > 0) {
        <div class="mb-4">
          <h5>Lignes de retour</h5>
          <p-table
            [value]="retourBonItems()"
            class="pharma-table"
            editMode="cell"
          >
            <ng-template #header>
              <tr class="pharma-table-head">
                <th>>CIP</th>
                <th>Produit</th>
                <th class="text-end">Qté Disponible</th>
                <th class="text-end pharma-qty-value">Qté à Retourner</th>
                <th>Motif de Retour</th>
                <th class="text-center">Action</th>
              </tr>
            </ng-template>
            <ng-template #body let-item let-rowIndex="rowIndex">
              <tr>
                <td><span class="pharma-code">{{ item.produitCip }}</span>  </td>
                <td><span class="pharma-product-name">{{ item.produitLibelle }}</span></td>
                <td class="text-end">{{ getMaxReturnQuantity(item) | number }}</td>
                <td class="text-end pharma-qty-value" pEditableColumn>
                  <p-cellEditor>
                    <ng-template #input>
                      <input
                        type="number"
                        [(ngModel)]="item.qtyMvt"
                        (ngModelChange)="onQuantityChange(item)"
                        [min]="1"
                        [max]="getMaxReturnQuantity(item)"
                        class="form-control form-control-sm text-end"
                        (focus)="$event.target.select()"
                      />
                    </ng-template>
                    <ng-template #output>
                      <span class="pharma-price">{{ item.qtyMvt | number }}</span>
                    </ng-template>
                  </p-cellEditor>
                </td>
                <td pEditableColumn>
                  <p-cellEditor>
                    <ng-template #input>
                      <p-select
                        [(ngModel)]="item.motifRetourId"
                        [options]="motifRetours()"
                        optionLabel="libelle"
                        optionValue="id"
                        [filter]="true"
                        filterBy="libelle"
                        placeholder="Sélectionner un motif"
                        class="w-100"
                      />
                    </ng-template>
                    <ng-template #output>
                      <span>{{ item.motifRetourLibelle || 'Non défini' }}</span>
                    </ng-template>
                  </p-cellEditor>
                </td>
                <td class="text-center">
                  <p-button
                    icon="pi pi-trash"
                    severity="danger"
                    [text]="true"
                    [rounded]="true"
                    (onClick)="removeReturnLine(rowIndex)"
                    pTooltip="Supprimer"
                    tooltipPosition="top"
                  />
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <!-- Commentaire -->
        <div class="mb-4">
          <p-floatlabel>
            <textarea
              id="commentaire"
              [(ngModel)]="commentaire"
              rows="3"
              class="form-control"
              maxlength="150"
              pInputTextarea
            ></textarea>
            <label for="commentaire">Commentaire (optionnel)</label>
          </p-floatlabel>
        </div>
      }

      <!-- Action Buttons -->
      <div class="d-flex justify-content-end gap-2">
        <p-button
          label="Annuler"
          icon="pi pi-times"
          severity="secondary"
          [outlined]="true"
          (onClick)="reset()"
        />
        <p-button
          label="Enregistrer"
          icon="pi pi-save"
          severity="primary"
          (onClick)="save()"
          [disabled]="!canSave() || isSaving()"
          [loading]="isSaving()"
        />
      </div>
    </div>
  </div>
</div>

</div>
