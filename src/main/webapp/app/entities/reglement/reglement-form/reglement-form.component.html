<form (ngSubmit)="save()" [formGroup]="reglementForm" class="reglement-form">
  <!-- Payment Settings Row -->
  <div class="payment-settings">
    <div class="toggle-field">
      <p-toggleswitch formControlName="partialPayment" inputId="partialPayment"></p-toggleswitch>
      <label for="partialPayment">Tout régler</label>
    </div>

    <div class="date-field">
      <p-inputgroup>
        <p-inputgroup-addon>
          <i class="pi pi-calendar"></i>
        </p-inputgroup-addon>
        <p-datePicker
          [defaultDate]="maxDate"
          [maxDate]="maxDate"
          [showButtonBar]="true"
          appendTo="body"
          dateFormat="dd/mm/yy"
          formControlName="paymentDate"
          id="datePaiement"
          selectOtherMonths="true"
        />
      </p-inputgroup>
    </div>
  </div>

  <!-- Payment Mode -->
  <div class="form-field-full">
    <p-inputgroup>
      <p-inputgroup-addon>
        <i class="pi pi-credit-card"></i>
      </p-inputgroup-addon>
      <p-select
        [fluid]="true"
        [options]="paymentModes"
        dataKey="code"
        formControlName="modePaimentCode"
        optionLabel="libelle"
        optionValue="code"
        placeholder="Sélectionner un mode de paiement"
      />
    </p-inputgroup>
  </div>

  <!-- Amount -->
  <div class="form-field-full">
    <p-inputgroup>
      <p-inputgroup-addon>
        <i class="pi pi-money-bill"></i>
      </p-inputgroup-addon>
      <input
        [fluid]="true"
        [readonly]="isReadOnly"
        class="text-right"
        formControlName="amount"
        pInputText
        pKeyFilter="int"
        placeholder="Montant"
      />
    </p-inputgroup>
  </div>

  <!-- Bank Information Section -->
  @if (showBanqueInfo) {
    <div class="bank-info-section" formGroupName="banqueInfo">
      <p-divider align="left">
        <div class="divider-content">
          <i class="pi pi-building"></i>
          <span>Informations bancaires</span>
        </div>
      </p-divider>

      <div class="bank-fields">
        <!-- Bank Name -->
        <div class="form-field-full">
          <p-inputgroup>
            <p-inputgroup-addon>
              <i class="pi pi-building"></i>
              <span class="addon-label">Nom</span>
            </p-inputgroup-addon>
            <input [fluid]="true" formControlName="nom" pInputText placeholder="Nom de la banque" />
          </p-inputgroup>
          @if (
            reglementForm.get('banqueInfo').get('nom')!.invalid &&
            (reglementForm.get('banqueInfo').get('nom')!.dirty || reglementForm.get('banqueInfo').get('nom')!.touched)
          ) {
            @if (reglementForm.get('banqueInfo').get('nom')?.errors?.required) {
              <small class="p-error">Ce champ est obligatoire.</small>
            }
          }
        </div>

        <!-- Check/Wire Number (conditional) -->
        @if (reglementForm.get('modePaimentCode')!.value === CH) {
          <div class="form-field-full">
            <p-inputgroup>
              <p-inputgroup-addon>
                <i class="pi pi-hashtag"></i>
                <span class="addon-label">Numéro</span>
              </p-inputgroup-addon>
              <input [fluid]="true" formControlName="code" pInputText pKeyFilter="alphanum" placeholder="Numéro de chèque" />
            </p-inputgroup>
            @if (
              reglementForm.get('banqueInfo').get('code')!.invalid &&
              (reglementForm.get('banqueInfo').get('code')!.dirty || reglementForm.get('banqueInfo').get('code')!.touched)
            ) {
              @if (reglementForm.get('banqueInfo').get('code')?.errors?.required) {
                <small class="p-error">Ce champ est obligatoire.</small>
              }
            }
          </div>
        }

        <!-- Beneficiary -->
        <div class="form-field-full">
          <p-inputgroup>
            <p-inputgroup-addon>
              <i class="pi pi-user"></i>
              <span class="addon-label">Bénéficiaire</span>
            </p-inputgroup-addon>
            <input [fluid]="true" formControlName="beneficiaire" pInputText placeholder="Nom du bénéficiaire" />
          </p-inputgroup>
        </div>
      </div>
    </div>
  }

  <!-- Submit Button -->
  <div class="form-actions">
    <p-button
      [disabled]="!valid || !validMontantSaisi() || isSaving()"
      [loading]="isSaving()"
      icon="pi pi-check"
      label="Valider"
      severity="success"
      type="submit"
    />
  </div>
</form>
