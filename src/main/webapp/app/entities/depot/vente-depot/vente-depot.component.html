<!-- Interface principale -->
<div class="pharma-sales-layout">
  <!-- HEADER TOOLBAR - Actions principales toujours visibles -->
  <div class="pharma-sales-header">
    <div class="header-left">
      <p-button (click)="previousState()" [rounded]="true" [text]="true" class="back-button" icon="pi pi-arrow-left" pTooltip="Retour">
      </p-button>

      <div class="page-title">
        <h1>Ventes dépôts</h1>
      </div>

      <!-- Vendeur Selection (Left Side) -->
      <div
        class="header-select-wrapper"
        style="display: flex !important; flex-direction: row !important; align-items: center !important; gap: 0.75rem !important"
      >
        <label
          class="header-label"
          style="
            margin: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0.375rem !important;
            white-space: nowrap !important;
          "
        >
          <i class="pi pi-user"></i>
          <span>Vendeur</span>
        </label>
        <p-select
          #userBox
          (onChange)="onSelectUser()"
          [(ngModel)]="userSeller"
          [appendTo]="appendTo"
          [dataKey]="'id'"
          [options]="this.userVendeurService.vendeurs()"
          [placeholder]="'Sélectionner un vendeur'"
          [style]="{ width: '200px' }"
          class="pharma-select-modern"
          optionLabel="abbrName"
        >
        </p-select>
      </div>

      <div
        class="header-select-wrapper"
        style="display: flex !important; flex-direction: row !important; align-items: center !important; gap: 0.75rem !important"
      >
        <label
          class="header-label"
          style="
            margin: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0.375rem !important;
            white-space: nowrap !important;
          "
        >
          <i class="pi pi-building"></i>
          <span>Dépôt</span>
        </label>
        <p-select
          #depotBox
          (onChange)="onSelectDepot()"
          [(ngModel)]="selectedDepot"
          [appendTo]="appendTo"
          [dataKey]="'id'"
          [options]="depotService.depots()"
          [placeholder]="'Sélectionner un dépôt'"
          [style]="{ width: '250px' }"
          class="pharma-select-modern"
          optionLabel="name"
        >
          <ng-template #item let-depot>
            <div class="depot-option">
              <div class="depot-name">{{ depot.name }}</div>
              @if (depot.address) {
                <div class="depot-address" style="font-size: 0.85rem; color: #6c757d">{{ depot.address }}</div>
              }
            </div>
          </ng-template>
        </p-select>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT AREA -->
  <div class="pharma-sales-body">
    <!-- MAIN WORK AREA -->
    <div class="sales-workspace">
      <!-- PRODUCT SEARCH SECTION -->
      <div class="product-search-section">
        <div class="search-section-header">
          <i class="pi pi-search"></i>
          <span>Recherche de produit</span>
        </div>

        <div class="search-controls">
          <!-- Product Search Autocomplete -->
          <div class="product-search-input">
            <jhi-produit-search-autocomplete-scanner
              #produitbox
              (onBarcodeScanned)="onBarcodeScanned($event)"
              (onKeyEnter)="onSaveKeyDown($event)"
              (selectedProduit)="onSelectProduct($event)"
              [(ngModel)]="produitSelected"
              [autofocus]="true"
              [enableScanner]="true"
              [includeDetails]="true"
              [pageSize]="PRODUIT_COMBO_RESULT_SIZE"
              class="pharma-autocomplete"
            >
            </jhi-produit-search-autocomplete-scanner>
          </div>

          <!-- Quantity Input -->
          <div class="quantity-input-wrapper">
            <jhi-quantite-produt-saisie
              #produitQteCmpt
              (addQuantite)="addQuantity($event)"
              [disabledButton]="disableButton"
              [isValid]="!!produitSelected"
              class="pharma-quantity-input"
            >
            </jhi-quantite-produt-saisie>
          </div>

          <!-- Product Meta Information -->
          @if (produitSelected) {
            <div class="product-meta">
              @if (showStock) {
                <div [class.low-stock]="(produitSelected?.totalQuantity || 0) < 10" class="meta-item">
                  <i class="pi pi-database"></i>
                  <span
                    >Stock: <strong>{{ produitSelected?.totalQuantity | number }}</strong></span
                  >
                </div>
              }

              @for (rayon of produitSelected?.rayons || []; track rayon.code) {
                <div class="meta-item">
                  <i class="pi pi-map-marker"></i>
                  <span>{{ rayon.libelle }}</span>
                </div>
              }

              <div class="meta-item price-display">
                <i class="pi pi-tag"></i>
                <span
                  >Prix: <strong>{{ produitSelected?.regularUnitPrice | number }} F</strong></span
                >
              </div>
            </div>
          }
        </div>
      </div>

      <!-- SALES CONTENT -->
      <div class="sale-content-area">
        @if (this.depotService.currentSale()) {
          <jhi-vente-depot-table
            (addRemiseEvent)="onAddRemise($event)"
            (deleteItemEvent)="confirmDeleteItem($event)"
            (itemPriceEvent)="updateItemPrice($event)"
            (itemQtyRequestedEvent)="updateItemQtyRequested($event)"
            (itemQtySoldEvent)="updateItemQtySold($event)"
            [canApplyDiscount]="canApplyDiscount()"
            [canModifyPrice]="canModifyPrice()"
            [canRemoveItem]="canRemoveItem()"
            [quantityMax]="depotService.quantityMax()"
            [sale]="depotService.currentSale()"
            (onSave)="onSaveAction($event)"
          >
          </jhi-vente-depot-table>
        }
      </div>
    </div>
  </div>
</div>

<!-- Composants de notification -->
<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>
<jhi-toast-alert #alert></jhi-toast-alert>

<jhi-spinner #spinner></jhi-spinner>
