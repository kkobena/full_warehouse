<div class="pharma-smart-content p-2">
  <div class="pharma-toolbar">
    <div class="pharma-toolbar-header">
      <i class="pi pi-credit-card"></i>
      <span class="pharma-toolbar-title">Règlement des différés</span>
    </div>

    <p-toolbar>
      <ng-template #start>
        <div class="pharma-toolbar-filters">
          <p-floatlabel variant="on" class="mr-1">
            <p-select
              id="clientFilter"
              (onChange)="onChange($event)"
              [(ngModel)]="customerId"
              [filter]="false"
              [options]="clients"
              [showClear]="true"
              [appendTo]="'body'"
              optionLabel="fullName"
              optionValue="id"
              size="large"
              style="min-width: 150px"
            >
            </p-select>
            <label for="clientFilter">Filtrer par clients</label>
          </p-floatlabel>

          <p-floatlabel variant="on" class="mr-1">
            <p-datePicker
              [(ngModel)]="modelStartDate"
              [iconDisplay]="'input'"
              [selectOtherMonths]="true"
              [showButtonBar]="true"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              id="du"
              inputId="du"
            />
            <label for="du">Du</label>
          </p-floatlabel>

          <p-floatlabel variant="on" class="mr-1">
            <p-datePicker
              [(ngModel)]="modelEndDate"
              [iconDisplay]="'input'"
              [selectOtherMonths]="true"
              [showButtonBar]="true"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              id="au"
              inputId="au"
            />
            <label for="au">Au</label>
          </p-floatlabel>
        </div>
      </ng-template>

      <ng-template #end>
        <div class="pharma-toolbar-actions">
          <div class="pharma-button-group">
            <p-button (click)="onSerch()" [loading]="loadingBtn" [raised]="true" icon="pi pi-search" label="Rechercher" severity="info" />
            <p-button (click)="exportPdf()" [loading]="loadingPdf" [raised]="true" icon="pi pi-file-pdf" label="Imprimer" severity="warn" />
          </div>
        </div>
      </ng-template>
    </p-toolbar>
  </div>

  @if (data.length) {
    <p-table
      (onLazyLoad)="lazyLoading($event)"
      [lazy]="true"
      [loading]="loading"
      [paginator]="true"
      [rowsPerPageOptions]="[10, 15, 20, 30, 50]"
      [rows]="itemsPerPage"
      [showCurrentPageReport]="false"
      [showGridlines]="true"
      [totalRecords]="totalItems"
      [value]="data"
      dataKey="id"
      stripedRows="true"
    >
      <ng-template #header>
        <tr>
          <th style="width: 3%"></th>
          <th>Client</th>
          <th>Montant payé</th>
          <th>Solde</th>
          <th></th>
        </tr>
      </ng-template>
      <ng-template #body let-differe let-expanded="expanded">
        <tr>
          <td>
            <p-button
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              [pRowToggler]="differe"
              [rounded]="true"
              [text]="true"
              type="button"
            />
          </td>
          <td>{{ differe.firstName + ' ' + differe.lastName }}</td>
          <td class="text-right amount-td-column">{{ differe.paidAmount | number }}</td>
          <td class="text-right amount-td-column red-400">{{ differe.solde | number }}</td>

          <td>
            <div class="btn-group d-flex justify-content-end">
              @if (differe.solde > 0) {
                <p-button
                  [rounded]="true"
                  [routerLink]="['/gestion-differe', differe.id, 'do-reglement-differe']"
                  [text]="true"
                  class="mr-1"
                  icon="pi pi-credit-card"
                  pTooltip="Faire un règlement"
                  severity="primary"
                >
                </p-button>
              } @else {
                <span class="pharma-badge pharma-badge-success">Soldé</span>
              }
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template #expandedrow let-elRow>
        <tr>
          <td colspan="5">
            <p-card>
              <table class="table table-secondary table-striped-columns table-bordered">
                <thead>
                  <tr class="table-secondary">
                    <th colspan="6">Règlements</th>
                  </tr>
                  <tr>
                    <th style="width: 2%">#</th>
                    <th>Date</th>
                    <th>Opérateur</th>
                    <th>Mode</th>
                    <th>Montant attendu</th>
                    <th>Montant payé</th>
                  </tr>
                </thead>
                <tbody>
                  @for (differeItem of elRow.items; track differeItem.id; let rowIndex = $index) {
                    <tr>
                      <td style="text-align: left">{{ rowIndex + 1 }}</td>
                      <td>{{ differeItem.mvtDate | date: 'dd/MM/yyyy HH:mm' }}</td>
                      <td>{{ differeItem.firstName + ' ' + differeItem.lastName }}</td>
                      <td>{{ differeItem.libelleMode }}</td>
                      <td class="text-right amount-td-column">{{ differeItem.expectedAmount | number }}</td>
                      <td class="text-right amount-td-column">{{ differeItem.paidAmount | number }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </p-card>
          </td>
        </tr>
      </ng-template>
      <ng-template #footer>
        <tr>
          <td class="p-text-left" colspan="2" style="font-weight: 700">TOTAL GENERAL</td>
          <td class="amount-column text-right">{{ summary?.paidAmount | number }}</td>
          <td class="amount-column text-right red-400">{{ summary?.solde | number }}</td>
          <td></td>
        </tr>
      </ng-template>
    </p-table>
  } @else {
    <div class="alert alert-warning" id="no-result">
      <span>Aucune donnée trouvée</span>
    </div>
  }
</div>
