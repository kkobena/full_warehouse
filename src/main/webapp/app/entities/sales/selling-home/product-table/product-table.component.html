@if (sale()) {
  <div class="pharma-table-wrapper">
    <!-- En-tête du tableau avec actions - VERSION COMPACTE -->
    <div class="pharma-table-header-compact">

      <!-- Recherche produit -->
      <div class="pharma-filter-search">
        <p-iconfield>
          <p-inputicon class="pi pi-search" />
          <input
            #filterInput
            (input)="produitTable.filterGlobal($event.target.value, 'contains')"
            pInputText
            placeholder="Rechercher un produit..."
            type="text"
            class="pharma-search-input"
          />
        </p-iconfield>
      </div>

      <!-- Séparateur vertical -->
      <div class="pharma-divider"></div>

      <!-- Section Remise -->
      <div class="pharma-remise-section">

        <!-- Badge Remise Info -->
        @if (currentSaleService.currentSale()?.remise) {
          <div class="pharma-remise-info">
            <i class="pi pi-percentage"></i>
            <span class="remise-label">Remise:</span>
            <strong class="remise-value">{{ remiseTaux() }}</strong>
          </div>
        }

        <!-- Sélecteur de remise -->
        @let remises = remiseCacheService.remises();
        @if (remises?.length > 0) {
          <p-select
            [(ngModel)]="selectedRemise"
            (onChange)="onSelectRemise()"
            [options]="remises"
            [group]="true"
            [showClear]="true"
            placeholder="Choisir une remise"
            optionLabel="valeur"
            class="pharma-remise-select-compact">
            <ng-template #group let-group>
              <div class="pharma-remise-group">
                <i class="pi pi-tag"></i>
                <span>{{ group.typeLibelle }}</span>
              </div>
            </ng-template>
          </p-select>
        }
      </div>
    </div>

    <!-- Tableau principal -->
    <p-table
      #produitTable
      [value]="sale().salesLines"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[5, 10, 20, 50]"
      [showCurrentPageReport]="true"
      [globalFilterFields]="['code', 'produitLibelle']"
      currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} produits"
      dataKey="id"
      selectionMode="single"
      class="pharma-table"
      [tableStyle]="{ 'min-width': '100%' }">

      <ng-template #header>

          <tr class="pharma-table-head">
            <th style="width: 15px; text-align: center; padding: 8px 5px">#</th>
            <th>CODE</th>
            <th>LIBELLÉ</th>
            <th style="width: 110px; text-align: center">QTÉ.D</th>
            <th style="width: 110px; text-align: center">QTÉ.S</th>
            <th style="width: 110px; text-align: right">PU</th>
            <th style="width: 130px; text-align: right">TOTAL</th>
            <th style="width: 50px; text-align: center"></th>
          </tr>

      </ng-template>

      <ng-template #body let-saleLine let-rowIndex="rowIndex">
        <tr [ngClass]="{
          'pharma-row-warning': saleLine.quantitySold < saleLine.quantityRequested,
          'pharma-row-hover': true
        }">
          <!-- Numéro -->
          <td style="text-align: center">
            <span class="pharma-row-number">{{ rowIndex + 1 }}</span>
          </td>

          <!-- Code -->
          <td>
            <span class="pharma-code">{{ saleLine.code }}</span>
          </td>

          <!-- Libellé -->
          <td>
            <div class="pharma-product-name">
              {{ saleLine.produitLibelle }}
            </div>
          </td>

          <!-- Quantité demandée - Éditable -->
          <td pEditableColumn class="text-right" >
            <p-cellEditor>
              <ng-template #input>
                <input
                  pInputText
                  type="number"
                  (focus)="$event.target.select()"
                  (keydown.enter)="updateItemQtyRequested(saleLine, $event)"
                  class="pharma-input-qty"
                  required
                />
              </ng-template>
              <ng-template #output>
                <span class="pharma-qty-value">{{ saleLine.quantityRequested | number }}</span>
              </ng-template>
            </p-cellEditor>
          </td>

          <!-- Quantité servie - Éditable -->
          <td pEditableColumn class="text-right">
            <p-cellEditor>
              <ng-template #input>
                <input
                  pInputText
                  type="number"
                  (focus)="$event.target.select()"
                  (keydown.enter)="updateItemQtySold(saleLine, $event)"
                  class="pharma-input-qty"
                  required
                />
              </ng-template>
              <ng-template #output>
                <span class="pharma-qty-value text-right">{{ saleLine.quantitySold | number }}</span>
              </ng-template>
            </p-cellEditor>
          </td>

          <!-- Prix unitaire - Éditable si autorisé -->
          @if (canModifiePrice) {
            <td pEditableColumn sclass="text-right">
              <p-cellEditor>
                <ng-template #input>
                  <input
                    pInputText
                    type="number"
                    (focus)="$event.target.select()"
                    (keydown.enter)="updateItemPrice(saleLine, $event)"
                    class="pharma-input-price"
                    required
                  />
                </ng-template>
                <ng-template #output>
                  <span class="pharma-price text-right">{{ saleLine.regularUnitPrice | number }}</span>
                </ng-template>
              </p-cellEditor>
            </td>
          } @else {
            <td style="text-align: right">
              <span class="pharma-price text-right">{{ saleLine.regularUnitPrice | number }}</span>
            </td>
          }

          <!-- Base de remboursement (uniquement pour assurance) -->
        <!--  @if (sale().natureVente === 'ASSURANCE') {
            <td [ngClass]="{ 'pharma-br-special': saleLine.calculationBasePrice !== undefined }"
                style="text-align: right">
              <span class="pharma-price">{{ saleLine.calculationBasePrice | number }}</span>
            </td>
          }-->

          <!-- Total -->
          <td style="text-align: right">
            <span class="pharma-total">{{ saleLine.salesAmount | number }}</span>
          </td>

          <!-- Actions -->
          <td style="text-align: center">
            <p-button
              (click)="onDeleteItem(saleLine)"
              icon="pi pi-trash"
              [rounded]="true"
              [text]="true"
              severity="danger"
              size="small"
              pTooltip="Supprimer"
              tooltipPosition="left"
            />
          </td>
        </tr>
      </ng-template>

      <ng-template #footer>
        @if (sale().salesLines.length > 0) {

            <tr class="pharma-table-footer">
              <td class="pharma-footer-label" colspan="3" style="text-align: left">
                <i class="pi pi-calculator"></i>
                <span>TOTAUX</span>
              </td>

              <td class="text-right">
                <span class="pharma-footer-value">{{ totalQtyProduit() | number }}</span>
              </td>
              <td class="text-right">
                <span class="pharma-footer-value">{{ totalQtyServi() | number }}</span>
              </td>

              <td colspan="2" class="text-right">
                <span class="pharma-footer-total">{{ totalTtc() | number }} </span>
              </td>
              <td></td>
            </tr>


        }
      </ng-template>
    </p-table>
  </div>
} @else {

  <div class="pharma-empty-content">
    <i class="pi pi-shopping-cart"></i>
    <p>Aucun produit ajouté</p>
    <small>Recherchez et ajoutez des produits pour commencer la vente</small>
  </div>
}

<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>
