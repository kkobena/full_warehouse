<!-- Drawer pour ventes en attente -->
<p-drawer [(visible)]="pendingSalesSidebar" [style]="{ width: '70vw' }" position="right">
  <ng-template #header>
    <i class="pi pi-clock text-xl"></i>
    <span class="font-bold text-xl">Ventes en attente</span>
  </ng-template>
  <ng-template #content>
    <jhi-prevente-modal
      (pendingSalesSidebarChange)="closeSideBar($event)"
      [user]="userCaissier">
    </jhi-prevente-modal>
  </ng-template>
</p-drawer>

<!-- Interface principale -->
<div class="pharma-container">
  <div class="pharma-row">


    <div class="pharma-sidebar">
      <div class="pharma-card">
        <div class="pharma-card-header">
          <i class="pi pi-cog"></i>
          <span>Les types de vente</span>
        </div>

        <div class="pharma-nav">
          <div
            #nav="ngbNav"
            (navChange)="onNavChange($event)"
            [(activeId)]="active"
            class="nav flex-column nav-pills"
            ngbNav
            orientation="vertical">

            <ng-container ngbNavItem="comptant">
              <a class="nav-link pharma-nav-link" ngbNavLink>Comptant</a>
              <ng-template ngbNavContent>
                <jhi-comptant
                  (inputToFocusEvent)="getControlToFocus($event)"
                  (responseEvent)="onFinalyse($event)"
                  (saveResponse)="onSave($event)"
                  [canFocusLastModeInput]="canFocusLastModeInput"
                  [isPresale]="isPresale">
                </jhi-comptant>
              </ng-template>
            </ng-container>

            <ng-container ngbNavItem="assurance">
              <a class="nav-link pharma-nav-link" ngbNavLink>Assurance</a>
              <ng-template ngbNavContent>
                <jhi-assurance [isPresale]="isPresale"></jhi-assurance>
              </ng-template>
            </ng-container>

            <ng-container ngbNavItem="carnet">
              <a class="nav-link pharma-nav-link" ngbNavLink>Carnet</a>
              <ng-template ngbNavContent>
                <jhi-carnet [isPresale]="isPresale"></jhi-carnet>
              </ng-template>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <!-- ZONE DE TRAVAIL PRINCIPALE -->
    <div class="pharma-content">

      <!-- Barre d'outils supérieure -->
      <div class="pharma-toolbar">
        <div class="pharma-toolbar-row">

          <!-- Vendeur -->
          <div class="pharma-toolbar-item" style="flex: 0 0 280px;">
            <p-floatlabel variant="on">
              <p-select
                #userBox
                (onChange)="onSelectUser()"
                [(ngModel)]="userSeller"
                [appendTo]="appendTo"
                [autofocus]="true"
                [dataKey]="'id'"
                [options]="this.userVendeurService.vendeurs()"
                [style]="{ width: '100%' }"
                class="pharma-select"
                id="vendeurs"
                optionLabel="abbrName">
              </p-select>
              <label for="vendeurs">{{ 'warehouseApp.sales.vendeurs' | translate }}</label>
            </p-floatlabel>
          </div>

          <!-- Client (si comptant) -->
          <div class="pharma-toolbar-item pharma-toolbar-grow">
            @if (active === 'comptant' && currentSaleService.currentSale()) {
              <jhi-customer-overlay-panel
                (onCloseEvent)="onCustomerOverlay($event)">
              </jhi-customer-overlay-panel>
            }
          </div>

          <!-- Actions -->
          <div class="pharma-toolbar-item pharma-toolbar-actions">


            <p-button
              (click)="openPindingSide()"
              [badge]="'1'"
              [disabled]="currentSaleService.currentSale() || isPresale"
              [rounded]="true"
              [variant]="'text'"
              badgeSeverity="danger"
              class="mr-2"
              icon="pi pi-clock"
              pTooltip="Ventes en attente"
              severity="info"
              size="small"
              tooltipPosition="left"
            ></p-button>


            <p-button (click)="previousState()"
                      icon="pi pi-arrow-left"
                      label="Retour"
                      severity="secondary"
                      size="small">
            </p-button>
          </div>
        </div>
      </div>

      <!-- Données assurance/carnet -->
      @if (active === 'assurance' || active === 'carnet') {
        <div class="pharma-toolbar pharma-assurance-toolbar">
          <jhi-assurance-data></jhi-assurance-data>
        </div>
      }

      <!-- Zone de saisie produit -->
      <div class="pharma-toolbar pharma-product-toolbar">
        <div class="pharma-toolbar-row">

          <!-- Recherche produit -->
          <div class="pharma-product-search">
            <jhi-produit-search-autocomplete-scanner
              #produitbox
              (onBarcodeScanned)="onBarcodeScanned($event)"
              (onKeyEnter)="onSaveKeyDown($event)"
              (selectedProduit)="onSelectProduct($event)"
              [(ngModel)]="produitSelected"
              [autofocus]="true"
              [enableScanner]="true"
              [includeDetails]="true"
              [pageSize]="PRODUIT_COMBO_RESULT_SIZE"
              class="pharma-autocomplete">
            </jhi-produit-search-autocomplete-scanner>
          </div>

          <!-- Quantité -->
          <div class="pharma-quantity">
            <jhi-quantite-produt-saisie
              #produitQteCmpt
              (addQuantite)="addQuantity($event)"
              [disabledButton]="disableButton"
              [isValid]="!!produitSelected"
              class="pharma-quantity-input">
            </jhi-quantite-produt-saisie>
          </div>

          <!-- Stock et Rayons -->
          @if (produitSelected) {
            <div class="product-info-badges">
              @if (showStock) {
                <p-tag [severity]="stockSeverity" class="mr-1">
                  <i class="pi pi-box"></i>
                  <span class="ml-1">Stock: {{ produitSelected?.totalQuantity | number }}</span>
                </p-tag>
              }

              @for (rayon of produitSelected?.rayons; track rayon.code) {
                <p-tag severity="info">
                  <i class="pi pi-map-marker"></i>
                  <span class="ml-1">{{ rayon.libelle }}</span>
                </p-tag>
              }
            </div>
          }
        </div>
      </div>

      <!-- Contenu des onglets de vente -->
      <div class="pharma-sale-content">
        <div [ngbNavOutlet]="nav"></div>
      </div>
    </div>
  </div>
</div>

<!-- Composants de notification -->
<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>
<jhi-toast-alert #alert></jhi-toast-alert>
