<div class="row">
  @if (showModeReglementCard()) {
    <div
      [ngClass]="currentSaleService.currentSale()?.amountToBePaid > 0 ? ' col-md-7 col-xl-7 col-lg-7 col-sm-12 mt-2' : ' col-md-10 col-xl-10 col-lg-10 col-sm-12 mt-2'">

      <div class="payment-modes-card">
        <div class="payment-modes-header">
          <div class="header-content">
            <i class="pi pi-money-bill"></i>
            <h3>Modes de règlement</h3>
          </div>
        </div>

        <div class="payment-modes-body">
          @if (currentSaleService.currentSale()?.type === 'VO' && baseSaleService.hasSansBon()) {
            <div class="toggle-option">
              <label for="sansBon">Vente sans bon</label>
              <p-toggleswitch inputId="sansBon" [(ngModel)]="isVenteSansBon"
                              (onChange)="onSansBonChange($event)"></p-toggleswitch>
            </div>
          }

          @if (currentSaleService.currentSale()?.amountToBePaid > 0) {
            <div class="row ws-mode-reglement" style="margin-top: 0.25rem">
              @for (modePay of selectModeReglementService.modeReglements(); track modePay.code) {
                <div
                  [ngClass]="isSmallScreen ? 'col-md-12 col-sm-12' : 'col-md-6 col-lg-6 col-xl-6'">
                  <p-inputgroup>
                    <p-inputgroup-addon [style]="{ padding: '0' }">
                      <span class="{{ modePay.styleBtnClass }}"></span>
                    </p-inputgroup-addon>
                    <input #paymentModeInput
                           autocomplete="off"
                           autofocus
                           (input)="manageCashPaymentMode($event, modePay)"
                           (keydown.enter)="save()"
                           size="large"
                           [(ngModel)]="modePay.amount"
                           [id]="modePay.code"
                           [pKeyFilter]="'int'"
                           [readOnly]="modePay.isReadonly"
                           class="payment-mode-input"
                           pInputText
                    />
                    @if (isShowAddBtn()) {
                      <p-inputgroup-addon [style]="{ padding: '0' }">
                        <p-button
                          (click)="onAddPaymentModeToggle(modePay, $event)"
                          class="add-mode-payment-btn"
                          icon="pi pi-plus"
                          severity="info"
                          type="button"
                        ></p-button>
                      </p-inputgroup-addon>
                    }

                    <p-inputgroup-addon [style]="{ padding: '0' }">
                      <p-button
                        (click)="onRemovePaymentModeToggle(modePay, $event)"
                        severity="danger"
                        icon="pi pi-times"
                        size="large"
                        type="button"
                      ></p-button>
                    </p-inputgroup-addon>
                  </p-inputgroup>
                </div>
              }
            </div>
          }
        </div>
      </div>

    </div>

    @if (manageShowInfosBancaire() || isDiffere()) {
      <div class="col-md-5 col-xl-5 col-lg-5 col-sm-12 mt-2">
        <div class="additional-info-card">
          <div class="additional-info-header">
            <div class="header-content">
              <i class="pi pi-info-circle"></i>
              <h3>Informations complémentaires</h3>
            </div>
          </div>

          <div class="additional-info-body">
            @if (isDiffere()) {
              <div class="info-field">
                <label>Commentaire</label>
                <input #commentaireInput
                       [(ngModel)]="commentaire"
                       pInputText
                       type="text"
                       [autofocus]="true"
                       (keydown.enter)="save()"
                       placeholder="Saisir un commentaire" />
              </div>
            }

            @if (manageShowInfosBancaire()) {
              <div class="bank-info-fields">
                <div class="info-field mb-1">
                  <label>Référence</label>
                  <input #referenceInput
                         [(ngModel)]="referenceBancaire"
                         pInputText
                         type="text"
                         placeholder="Référence bancaire" />
                </div>

                <div class="info-field mb-1">
                  <label>Banque</label>
                  <input #banqueInput
                         [(ngModel)]="banque"
                         pInputText
                         type="text"
                         placeholder="Nom de la banque" />
                </div>

                <div class="info-field">
                  <label>Lieu</label>
                  <input #lieuxInput
                         [(ngModel)]="lieux"
                         pInputText
                         type="text"
                         placeholder="Lieu" />
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    }
  }
</div>

<!-- Popovers -->
<p-popover #addOverlayPanel [style]="{ width: '450px' }">
  <ng-template #content>
    <div class="d-flex flex-wrap">
      @for (modePay of reglementsModes; track modePay.code; let i = $index) {
        <ng-container>
          <div (click)="onAddPaymentMode(modePay)" class="p-2 mode-reglement-icon">
            <span class="{{ modePay.styleImageClass }}"></span>
          </div>
        </ng-container>
      }
    </div>
  </ng-template>
</p-popover>

<p-popover #removeOverlayPanel [style]="{ width: '450px' }">
  <ng-template #content>
    <div class="d-flex flex-wrap">
      @for (modePay of reglementsModes; track modePay.code; let i = $index) {
        <ng-container>
          <div (click)="onRemovePaymentMode(modePay)" class="p-2 mode-reglement-icon">
            <span class="{{ modePay.styleImageClass }}"></span>
          </div>
        </ng-container>
      }
    </div>
  </ng-template>
</p-popover>

<p-popover #customerModal [style]="{ width: '650px' }">
  <ng-template #content>
    <jhi-customer-data-table (closeModalEvent)="onClose(customerModal)"></jhi-customer-data-table>
  </ng-template>
</p-popover>
