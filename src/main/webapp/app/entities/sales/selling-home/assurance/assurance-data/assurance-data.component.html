<!-- Modern Assurance Data Component -->
<div class="assurance-data-wrapper">

  <!-- Search Section -->
  @if (!selectedCustomerService.selectedCustomerSignal() || !currentSaleService.currentSale()) {
    <div class="search-section">
      <p-iconfield class="search-input-wrapper">
        <p-inputicon class="pi pi-search" />
        <input
          #searchInput
          (keydown.enter)="load()"
          [(ngModel)]="search"
          autocomplete="off"
          class="search-input"
          pInputText
          [fluid]="true"
          placeholder="Rechercher un client assuré..."
          type="text"
        />
      </p-iconfield>
    </div>
  }

  <!-- Customer Information Cards -->
  @if (selectedCustomerService.selectedCustomerSignal()) {
    <div class="customer-data-grid">

      <!-- Assuré Card -->
      <div [class]="divCustomer()">
        <div class="data-card assured-card">
          <div class="card-header">
            <div class="header-title">
              <i class="pi pi-user-shield"></i>
              <span>Assuré</span>
            </div>

            <p-splitbutton
              [model]="assureBtnActions"
              [text]="true"
              icon="pi pi-user-edit"
              label="Gérer"
              severity="info"
              size="small">
            </p-splitbutton>

          </div>
          <div class="card-body">
            <div class="info-row">
              <span class="info-label">Nom/Prénom(s)</span>
              <span class="info-value">
                {{ selectedCustomerService.selectedCustomerSignal().firstName }}
                {{ selectedCustomerService.selectedCustomerSignal().lastName }}
              </span>
            </div>
            <div class="info-row">
              <span class="info-label">Matricule</span>
              <span class="info-value matricule">{{ selectedCustomerService.selectedCustomerSignal().num }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Ayant Droit Card (for ASSURANCE only) -->
      @if (currentSaleService.typeVo() === 'ASSURANCE') {
        <div [class]="divCustomer()">
          <div class="data-card ayant-droit-card">
            <div class="card-header">
              <div class="header-title">
                <i class="pi pi-users"></i>
                <span>Ayant droit</span>
              </div>
              @if (ayantDroit?.id === selectedCustomerService.selectedCustomerSignal().id) {
                <p-button
                  (click)="loadAyantDoits()"
                  [variant]="'text'"
                  icon="pi pi-users"
                  label="Remplacer"
                  size="small"
                  class="edit-btn">
                </p-button>
              } @else {
                <p-splitbutton
                  [model]="items"
                  [text]="true"
                  icon="pi pi-user-edit"
                  label="Gérer"
                  severity="info"
                  size="small">
                </p-splitbutton>
              }
            </div>
            @if (ayantDroit) {
              <div class="card-body">
                <div class="info-row">
                  <span class="info-label">Nom/Prénom(s)</span>
                  <span class="info-value">{{ ayantDroit.firstName }} {{ ayantDroit.lastName }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Matricule</span>
                  <span class="info-value matricule">{{ ayantDroit.num }}</span>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Tiers Payants Cards -->
      @for (tp of selectedTiersPayants(); track tp.id; let i = $index) {
        <div [class]="divClass()">
          <div class="data-card tiers-payant-card">
            <div class="tp-header">
              <div class="tp-title">
                @if (i === 0) {
                  <span class="tp-badge ro-badge">RO</span>
                } @else {
                  <span class="tp-badge rc-badge">RC{{ i }}</span>
                }
                <span class="tp-name">{{ tp.tiersPayantName }}</span>
              </div>
              <div class="tp-rate">
                <span class="rate-label">Taux:</span>
                <span class="rate-value">{{ tp.taux }}%</span>
              </div>
            </div>

            <div class="tp-input-section">
              <p-inputgroup>
                <p-inputgroup-addon>
                  <i class="pi pi-ticket"></i>
                  <span>Bon</span>
                </p-inputgroup-addon>
                <input
                  #tpInput
                  (keydown.enter)="onBonEnter(tp)"
                  [(ngModel)]="tp.numBon"
                  [fluid]="true"
                  size="small"
                  autocomplete="off"
                  class="bon-input"
                  id="bon-{{ tp.id }}"
                  name="bon-{{ i }}"
                  pInputText
                  pKeyFilter="alphanum"
                  type="text"
                  placeholder="Numéro de bon..."
                />
                @if (selectedTiersPayants().length > 1) {
                  <p-inputgroup-addon>
                    <p-button
                      (click)="removeTiersPayant(tp)"
                      icon="pi pi-trash"
                      pTooltip="Supprimer ce tiers payant"
                      tooltipPosition="top"
                      severity="danger"
                      [text]="true"
                      type="button">
                    </p-button>
                  </p-inputgroup-addon>
                }
                @if (selectedCustomerService.selectedCustomerSignal()
                  && selectedTiersPayants().length < selectedCustomerService.selectedCustomerSignal().tiersPayants.length
                  && currentSaleService.typeVo() === 'ASSURANCE') {
                  <p-inputgroup-addon>
                    <p-button
                      (click)="addComplementaire()"
                      icon="pi pi-plus"
                      pTooltip="Ajouter un tiers payant complémentaire"
                      tooltipPosition="top"
                      severity="success"
                      [text]="true"
                      type="button">
                    </p-button>
                  </p-inputgroup-addon>
                }
              </p-inputgroup>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

<jhi-confirm-dialog #confirmDialog></jhi-confirm-dialog>
